<html>
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge;" />
	<script src="./js/jquery.min.js"></script>
    <script src="./dist/js/bootstrap.js"></script>
    <script src="./dist/js/sidebar.js"></script>
    <link rel="stylesheet" href="./dist/css/bootstrap.css" />
    <link rel="stylesheet" href="./style.css" />
    <link rel="stylesheet" href="./dist/css/sidebar.css"/>
	<link rel="stylesheet" href="./lib/font-awesome/css/font-awesome.min.css"/>
	<link rel="stylesheet" href="lib/bootstrap-table/dist/bootstrap-table.css">
	<link rel="stylesheet" href="lib/select2/css/select2.min.css">	<!-- Botstrap table plugin -->
	<link rel="stylesheet" href="lib/bootstrap-slider/css/bootstrap-slider.css">
	
	<link href="../iClient/for3D/webgl/examples/css/widgets.css" rel="stylesheet">
    <!--<link href="../iClient/for3D/webgl/examples/css/examples.css" rel="stylesheet">-->
    <!--<link href="../iClient/for3D/webgl/examples/css/flat-ui.css" rel="stylesheet">-->		<!-- What is this flat-ui? -->
	
	<style>
        html, body, #cesiumContainer, #streetViewContainer, #SMapContainer {
            width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden;
        }
		
		#cesiumContainer {
			position: absolute;
		}
		
		#streetViewContainer, #SMapContainer {
			z-index: 1050;
			display: none;
			position: absolute;
		}
		
		.leftIcon {
			margin-top: 10px;
			margin-left: 7px;
			color: white;
		}
		
		#leftPanel {
			position:absolute;
			width: 50px;
			left: 0px;
			top: 0px;
			z-index:1000 !important;
			background-color:#263238;
		}
		
		#leftIconList {
			position: relative;
			/*top: 100px;*/
		}
		
		a, li, h4 {
			font-family: Arial, Helvetica, sans-serif !important;
		}
		
		#upperDiv {
			top: 0px;
			left: 0px;
			width: 100%;
		}
		
		#bottomDiv {
			position: absolute;
			bottom: 0px;
			left: 0px;
			width: 100%;
			z-index: 1000;
		}
		
		.bottom-info {
			opacity: 1 !important;
			color: #000 !important;
			background-color: #EEE !important;
			cursor: default !important;
			margin-left: 1%;
			margin-bottom: 5px;
			height: 25px;
			float:left;
		}
		
		.rightToolContainer {
			background-color: rgba(125, 125, 125, 0.7);
			width: 36px;
			text-align: center;
			margin-bottom: 2px;
			border-radius: 5px;
		}
		
		.toolsetPanel {
			background-color: rgba(0, 0, 0, 0) !important;
			border: 0px !important;
			color: #00f8fc;
		}
		
		.toolsetItem3D {
			cursor: pointer;
			color: white;
		}
		
		.toolsetItem2D {
			cursor: pointer;
			color: purple;
		}
		
		/* Hide modal backdrop to make background displayable */
		.modal {
			overflow: hidden;
			bottom:initial! important;
		}
		.modal-backdrop {
			display: none !important;
			pointer-events: none;
		}
		
		.movable {
			-webkit-user-select: none; /* Chrome/Safari */        
			-moz-user-select: none; /* Firefox */
			-ms-user-select: none; /* IE10+ */
		}
		
		th {
			background-color: #eeeeee;
		}

		.cesium-widget-credits {
			display: none !important;
		}
		
		#ex1Slider .slider-selection {
			background: #BABABA;
		}
    </style>
</head>
<body>
<!-- Fixed navbar -->
	<div id="upperDiv">
		<div id="leftPanel">
			<button type="button" class="navbar-toggle leftBtn" id="btnLayerManager" data-toggle="sidebar" data-target=".sidebar-left"
				style="display:none;">
			  <span class="icon-bar"></span>
			  <span class="icon-bar"></span>
			  <span class="icon-bar"></span>
			</button>
			
			<button type="button" class="btn btn-primary" id="btnAttributeTable" data-toggle="modal" data-target="#dialogModal" data-backdrop="static" data-keyboard="false" style="display:none;">
				This button shows attribute table
			</button>
			<button type="button" class="btn btn-primary" id="btnFlyToTrigger" data-toggle="modal" data-target="#flyToModal" data-backdrop="static" data-keyboard="false" style="display:none;">
				This button shows fly to modal
			</button>
			<button type="button" class="btn btn-primary" id="btnTranspTrigger" data-toggle="modal" data-target="#transpModal" data-backdrop="static" data-keyboard="false" style="display:none;">
				This button shows transparency control
			</button>
			<button type="button" class="btn btn-primary" id="btnTranspTrigger2D" data-toggle="modal" data-target="#transpModal2D" data-backdrop="static" data-keyboard="false" style="display:none;">
				This button shows transparency control for 2D
			</button>
			<button type="button" class="btn btn-primary" id="btnLayerReorder" data-toggle="modal" data-target="#reorderModal" data-backdrop="static" data-keyboard="false" style="display:none;">
				This button shows layer reorder control for 2D
			</button>
			<button type="button" class="btn btn-primary" id="btnZoomTo" data-toggle="modal" data-target="#zoomToModal" data-backdrop="static" data-keyboard="false" style="display:none;">
				This button shows zoom to control for 2D
			</button>
			
			<div id="leftIconList">
				<i class="fa fa-list fa-2x leftIcon" data-toggle="sidebar" aria-hidden="true" id="iconLayerManager"></i>
			</div>
			
			<div>
				<i class="fa fa-table fa-2x leftIcon" aria-hidden="true" id="iconAttributeTable"></i>
			</div>
			
			<!--
			<div>
				<i class="fa fa-arrow-up fa-2x leftIcon" aria-hidden="true" id="iconDummyUp" onclick="threeDGIS.threeDView.viewer.imageryLayers.raise(dopLayer);"></i>
			</div>
			
			<div>
				<i class="fa fa-arrow-down fa-2x leftIcon" aria-hidden="true" id="iconDummyDown" onclick="threeDGIS.threeDView.viewer.imageryLayers.lower(dopLayer);"></i>
			</div>
			-->
		</div>
	  
	  <!-- Begin page content -->
		<div id="viewContainer" style="position:relative; top:0px; left:50px; height:100%; z-index:0;">
			<!-- Debug with cesiumContainer2 -->
			<div id="cesiumContainer">
				<!-- <div id="slider"></div> -->	<!-- Split screen with slider, leave this blank by now -->
			</div>
			<div id="SMapContainer"></div>
			<div id="streetViewContainer"></div>
		</div>
		<div class="container-fluid">
			<div class="row">
			<div class="col-xs-5 col-sm-3 col-md-3 sidebar sidebar-left sidebar-animate">
				<div class="panel-group" id="accordion">
					<div class="panel panel-default">
						<div class="panel-heading">
							<h4 class="panel-title">
								<a data-toggle="collapse" data-parent="#accordion" href="#collapseOne">Layer manager</a>
							</h4>
						</div>
						<div id="collapseOne" class="panel-collapse collapse in">
							<div id="3DLayers">
								<ul class="list-group checked-list-box" id="layerList">
									<li class="list-group-item" data-checked="true">Base_Map</li>
									<!-- <li class="list-group-item" data-checked="true">SPOT_RGB</li> -->
									<li class="list-group-item" data-checked="true">OZP_Zone</li>
									<li class="list-group-item" data-checked="true">Lot_Map</li>
									<li class="list-group-item" data-checked="true">Terrain</li>
									<li class="list-group-item" data-checked="true">AAM_Model</li>
									<li class="list-group-item" data-checked="true">bldg_wgs</li>
									<li class="list-group-item" data-checked="true">podium_wgs</li>
									<li class="list-group-item" data-checked="true">PolyU</li>
									<li class="list-group-item" data-checked="true">cyber_port</li>
									<li class="list-group-item" data-checked="true">TaiKooShing</li>
									<li class="list-group-item" data-checked="true">SaiKung</li>
								</ul>
							</div>
							
							<div id="2DLayers" style="display:none">
								<ul class="list-group checked-list-box" id="layerList2D">
									<li class="list-group-item" data-checked="true">Tree</li>
									<li class="list-group-item" data-checked="true">Building</li>
									<li class="list-group-item" data-checked="true">Podium</li>
									<li class="list-group-item" data-checked="true">DOP</li>
								</ul>
							</div>
						</div>
					</div>
					<div class="panel panel-default">
						<div class="panel-heading">
							<h4 class="panel-title">
								<a data-toggle="collapse" data-parent="#accordion" href="#collapseFour">Bookmark manager</a>
							</h4>
						</div>
						<div id="collapseFour" class="panel-collapse collapse">
							Fly to bookmark: <select id="bookmarks" name="bookmarks" style="width: 200px;"></select><br /><br />
							<input type="button" class="btn" value="Add a bookmark for current view" onclick="addBookmark()" /><br /><br />
							<input id="deleteButton" type="button" class="btn" value="Delete selected bookmark" onclick="deleteBookmark()" disabled/>
						</div>
					</div>
					<div class="panel panel-default">
						<div class="panel-heading">
							<h4 class="panel-title">
								<a data-toggle="collapse" data-parent="#accordion" href="#collapseFive">Search attribute</a>
							</h4>
						</div>
						<div id="collapseFive" class="panel-collapse collapse">
							Search location: <br />
							<input type="text" id="queryValue" style="width: 200px;" value="" /><br />
							<button id="searchButton">Search</button>
						</div>
					</div>
					<div class="panel panel-default">
						<div class="panel-heading">
							<h4 class="panel-title">
								<a data-toggle="collapse" data-parent="#accordion" href="#collapseEditing">Edit blocks</a>
							</h4>
						</div>
						<div id="collapseEditing" class="panel-collapse collapse">
							Selected block:&nbsp;<span id="valueSelectedBlock"></span>
							<br />
							Height:&nbsp;
							<input id="exBlockHeight" data-slider-id='ex1Slider' type="text" data-slider-min="1" data-slider-max="400" data-slider-step="1" data-slider-value="1"/>
							<br /><br />
							Edit mode:&nbsp;<select id="selectEditMode">
								<option value="1" selected>Reshape</option>
								<option value="8">Move</option>
								<option value="4">Rotate</option>
								<option value="2">Resize</option>
							</select>
							<br /><br />
							Building Height: <span id="txtHt"></span>
							<br />
							No. of Floor (3m): <span id="txtNoFloor"></span>
							<br />
							Footprint Area sq.m: <span id="txtArea"></span>
														
							<br />
							GFA (Area × No. of Floor): <span id="txtGFA"></span>
							<br /><br />
							<button id="btnEditConfirm" disabled>Start Edit</button>
						</div>
					</div>
				</div>
			</div>
		</div>
		
		<!-- Enable toolset to be collapsed. Not implemented -->
		<!-- <div id="toolset" style="position:absolute; right:10px; bottom:120px; z-index=3000;">
			<div class="panel-group">
				<div class="panel panel-default toolsetPanel">
					<div id="collapseTool" class="panel-collapse collapse">
						<ul class="list-group checked-list-box" id="layerList">
							<li><a href="#" data-toggle="tooltip" data-placement="left" title="Fly&nbsp;management"><i class="fa fa-plane fa-2x toolsetItem" aria-hidden="true"></i></a></li>
							<li><a href="#" data-toggle="tooltip" data-placement="left" title="Identification"><i class="fa fa-eye fa-2x toolsetItem" aria-hidden="true"></i></a></li>
							<li><a href="#" data-toggle="tooltip" data-placement="left" title="Search"><i class="fa fa-search fa-2x toolsetItem" aria-hidden="true"></i></a></li>
							<li><a href="#" data-toggle="tooltip" data-placement="left" title="Skyline&nbsp;analysis" id="btnSkyline"><i class="fa fa-list-alt fa-2x toolsetItem" aria-hidden="true"></i></a></li>
							<li><a href="#" data-toggle="tooltip" data-placement="left" title="Viewshed&nbsp;analysis" id="btnViewshed"><i class="fa fa-list-alt fa-2x toolsetItem" aria-hidden="true"></i></a></li>
							<li><a href="#" data-toggle="tooltip" data-placement="left" title="Walk&nbsp;mode" id="btnWalkmode"><span class="glyphicon glyphicon-road toolsetItem" style="font-size: 28px;" aria-hidden="true"></span></a></li>
							<!-- <li><a href="#" data-toggle="tooltip" data-placement="left" title="Street&nbsp;view" id="btnStreetView"><span class="glyphicon glyphicon-road toolsetItem" style="font-size: 28px;" aria-hidden="true"></span></a></li>
						</ul>
					</div>
					<div>
						<a data-toggle="collapse" href="#collapseTool" style="text-align: right;">
							<i class="fa fa-wrench fa-2x toolsetItem" aria-hidden="true"></i>
						</a>
					</div>
				</div>
			</div>
		</div> -->
		
		<div id="toolset3D" style="position:absolute; right:10px; bottom:120px; z-index=3000;">
			<div class="rightToolContainer"><a href="#" data-toggle="tooltip" data-placement="left" title="2D&nbsp;Map" class="btnToggleMapMode"><i class="fa fa-map fa-2x toolsetItem3D" aria-hidden="true"></i></a><br /></div>
			<div class="rightToolContainer"><a href="#" data-toggle="tooltip" data-placement="left" title="Fly&nbsp;to&nbsp;location" id="iconFlyTo"><i class="fa fa-plane fa-2x toolsetItem3D" aria-hidden="true"></i></a><br /></div>
			<div class="rightToolContainer"><a href="#" data-toggle="tooltip" data-placement="left" title="Settings" id="iconSettings"><i class="fa fa-cog fa-2x toolsetItem3D" aria-hidden="true"></i></a><br /></div>
			<div class="rightToolContainer"><a href="#" data-toggle="tooltip" data-placement="left" title="3D&nbsp;Measurement" id="icon3DMeasure"><i class="fa fa-arrows-h fa-2x toolsetItem3D" aria-hidden="true"></i></a><br /></div>
			<div class="rightToolContainer"><a href="#" data-toggle="tooltip" data-placement="left" title="Edit&nbsp;block" id="iconEditBlock"><i class="fa fa-pencil fa-2x toolsetItem3D" aria-hidden="true"></i></a><br /></div>
			<div class="rightToolContainer"><a href="#" data-toggle="tooltip" data-placement="left" title="Split&nbsp;screen" id="iconSplitScreen"><i class="fa fa-window-restore fa-2x toolsetItem3D" aria-hidden="true"></i></a><br /></div>
			<div class="rightToolContainer"><a href="#" data-toggle="tooltip" data-placement="left" title="Adjust&nbsp;transparency" id="iconTransp"><i class="fa fa-square-o fa-2x toolsetItem3D" aria-hidden="true"></i></a><br /></div>
			<!-- <li><a href="#" data-toggle="tooltip" data-placement="left" title="Fly&nbsp;management"><i class="fa fa-plane fa-2x toolsetItem" aria-hidden="true"></i></a></li>
			<li><a href="#" data-toggle="tooltip" data-placement="left" title="Identification"><i class="fa fa-eye fa-2x toolsetItem" aria-hidden="true"></i></a></li>
			<li><a href="#" data-toggle="tooltip" data-placement="left" title="Search"><i class="fa fa-search fa-2x toolsetItem" aria-hidden="true"></i></a></li> -->
			<div class="rightToolContainer"><a href="#" data-toggle="tooltip" data-placement="left" title="Profile&nbsp;analysis" id="btnProfile"><i class="fa fa-area-chart fa-2x toolsetItem3D" aria-hidden="true"></i></a><br /></div>
			<div class="rightToolContainer"><a href="#" data-toggle="tooltip" data-placement="left" title="Skyline&nbsp;analysis" id="btnSkyline"><i class="fa fa-list-alt fa-2x toolsetItem3D" aria-hidden="true"></i></a><br /></div>
			<div class="rightToolContainer"><a href="#" data-toggle="tooltip" data-placement="left" title="Viewshed&nbsp;analysis" id="btnViewshed"><i class="fa fa-list-alt fa-2x toolsetItem3D" aria-hidden="true"></i></a><br /></div>
			<div class="rightToolContainer"><a href="#" data-toggle="tooltip" data-placement="left" title="Clear&nbsp;analysis" id="btnClearAll" onclick="threeDGIS.threeDView.removeAnalysisEntities();"><i class="fa fa-trash fa-2x toolsetItem3D" aria-hidden="true"></i></a><br /></div>
			<div class="rightToolContainer"><a href="#" data-toggle="tooltip" data-placement="left" title="Walk&nbsp;mode" id="btnWalkmode"><span class="glyphicon glyphicon-road toolsetItem3D" style="font-size: 28px;" aria-hidden="true"></span></a><br /></div>
			<div class="rightToolContainer" style="display:none;"><a href="#" data-toggle="tooltip" data-placement="left" title="Street&nbsp;view" id="btnStreetView"><i class="fa fa-street-view fa-2x toolsetItem3D" aria-hidden="true"></i></a><br /></div>
			<div class="rightToolContainer"><a href="#" data-toggle="tooltip" data-placement="left" title="Add&nbsp;model" id="btnAddModel"><span class="fa fa-building fa-2x toolsetItem3D" style="font-size: 28px;" aria-hidden="true"></span></a><br /></div>
			<div class="rightToolContainer"><a href="#" data-toggle="tooltip" data-placement="left" title="Screen&nbsp;capture" id="btnCapture"><i class="fa fa-picture-o fa-2x toolsetItem3D" aria-hidden="true"></i></a><br /></div>
			<div class="rightToolContainer"><a href="#" data-toggle="tooltip" data-placement="left" title="Buffer&nbsp;analysis" id="btnBuffer"><span class="glyphicon glyphicon-record toolsetItem3D" style="font-size: 28px;" aria-hidden="true"></span></a><br /></div>
		</div>
		
		<div id="toolsetEditing" style="position:absolute; right:10px; bottom:120px; z-index=3000; display:none">
			<div class="rightToolContainer"><a href="#" data-toggle="tooltip" data-placement="left" title="Add&nbsp;block" id="btnAddBlock"><i class="fa fa-plus fa-2x toolsetItem3D" aria-hidden="true"></i></a><br /></div>
			<div class="rightToolContainer"><a href="#" data-toggle="tooltip" data-placement="left" title="Delete&nbsp;block" id="btnDeleteBlock"><i class="fa fa-trash fa-2x toolsetItem3D" aria-hidden="true"></i></a><br /></div>
			<div class="rightToolContainer"><a href="#" data-toggle="tooltip" data-placement="left" title="Back&nbsp;to&nbsp;3D" id="btnBackTo3D"><i class="fa fa-chevron-circle-left fa-2x toolsetItem3D" aria-hidden="true"></i></a><br /></div>
		</div>
		
		<div id="toolset2D" style="position:absolute; right:10px; bottom:120px; z-index=3000; display: none;">
			<div class="rightToolContainer"><a href="#" data-toggle="tooltip" data-placement="left" title="3D&nbsp;Scene" class="btnToggleMapMode"><i class="fa fa-fort-awesome fa-2x toolsetItem2D" aria-hidden="true"></i></a><br /></div>
			<div class="rightToolContainer"><a href="#" data-toggle="tooltip" data-placement="left" title="Zoom&nbsp;to&nbsp;Scale" id="btnSetScale2D"><i class="fa fa-arrows-h fa-2x toolsetItem2D" aria-hidden="true"></i></a><br /></div>
			<div class="rightToolContainer"><a href="#" data-toggle="tooltip" data-placement="left" title="Zoom&nbsp;to" id="iconZoomTo"><i class="fa fa-plane fa-2x toolsetItem2D" aria-hidden="true"></i></a><br /></div>
			<div class="rightToolContainer"><a href="#" data-toggle="tooltip" data-placement="left" title="Adjust&nbsp;transparency" id="iconTransp2D"><i class="fa fa-square-o fa-2x toolsetItem2D" aria-hidden="true"></i></a><br /></div>
			<div class="rightToolContainer"><a href="#" data-toggle="tooltip" data-placement="left" title="Layer&nbsp;reorder" id="iconLayerReorder"><i class="fa fa-arrows-v fa-2x toolsetItem2D" aria-hidden="true"></i></a><br /></div>
		</div>
	</div>
	
	<div id="bottomDiv">
		<input type="text" class="form-control bottom-info input-sm" id="txtLocation" value="Location" style="width: 24%;" disabled>
		<input type="text" class="form-control bottom-info input-sm" id="txtScaleElev" value="Elevation" style="width: 24%;" disabled>
		<input type="text" class="form-control bottom-info input-sm" id="txtSystemInfo" value="System Message" style="width: 48%;" disabled>
	</div>
	
	<div class="modal fade" id="dialogModal" tabindex="-1" role="dialog" aria-labelledby="dialogModalLabel" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<span class="modal-title" id="exampleModalLabel">Attribute table</span>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body" id="dialogBody" style="overflow: auto; max-height:800px; max-width:800px;">
					<table class="table table-bordered" id="attributeTable"
                               data-toggle="table"
							   data-height="650"
							   data-pagination="true"
							   data-page-size="10"
							   data-page-list="[10,50,100]"
							   data-show-export="true"
							   data-pagination-first-text="First"
							   data-pagination-pre-text="Previous"
							   data-pagination-next-text="Next"
							   data-pagination-last-text="Last">
					</table>
				</div>
				<!-- <div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
				</div> -->
			</div>
		</div>
	</div>
	
	<div class="modal fade" id="flyToModal" tabindex="-1" role="dialog" aria-labelledby="dialogModalLabel" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<span class="modal-title">Fly to location</span>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body" id="flyToBody" style="overflow: auto; max-height:600px; max-width:800px;">
					<table>
						<tr>
							<td style="width:300px;">Easting:</td>
							<td><input id="txtLng"></input></td>
						</tr>
						<tr>
							<td>Northing:</td>
							<td><input id="txtLat"></input></td>
						</tr>
						<tr>
							<td>Height:</td>
							<td><input id="txtHeight"></input></td>
						</tr>
						<tr>
							<td>Head (deg):</td>
							<td><input id="txtHead"></input></td>
						</tr>
						<tr>
							<td>Tilt (deg):</td>
							<td><input id="txtTilt"></input></td>
						</tr>
					</table>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal" id="btnFlyTo">Fly to location</button>
				</div>
			</div>
		</div>
	</div>
	
	<div class="modal fade" id="zoomToModal" tabindex="-1" role="dialog" aria-labelledby="dialogModalLabel" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<span class="modal-title">Zoom to location</span>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body" id="zoomToBody" style="overflow: auto; max-height:600px; max-width:800px;">
					<table>
						<tr>
							<td style="width:300px;">Easting:</td>
							<td><input id="txtEasting"></input></td>
						</tr>
						<tr>
							<td>Northing:</td>
							<td><input id="txtNorthing"></input></td>
						</tr>
					</table>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal" id="btnZoomToGo">Zoom to location</button>
				</div>
			</div>
		</div>
	</div>
	
	<div class="modal fade" id="transpModal" tabindex="-1" role="dialog" aria-labelledby="dialogModalLabel" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<span class="modal-title">Change transparency</span>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body" id="transpBody" style="overflow: auto; max-height:600px; max-width:800px;">
					<select id="transpLayers">
						<option value="Base_Map">Base_Map</option>
						<option value="OZP_Zone">OZP_Zone</option>
						<option value="SPOT_RGB">SPOT_RGB</option>
						<option value="AAM_Model">AAM_Model</option>
						<option value="bldg_wgs">bldg_wgs</option>
						<option value="podium_wgs">podium_wgs</option>
						<option value="PolyU">PolyU</option>
						<option value="cyber_port">cyber_port</option>
						<option value="TaiKooShing">TaiKooShing</option>
						<option value="SaiKung">SaiKung</option>
					</select>
					<br /><br />
					Layer transparency:&nbsp;&nbsp;<input id="ex1" data-slider-id='ex1Slider' type="text" data-slider-min="0" data-slider-max="100" data-slider-step="1" data-slider-value="100"/>
				</div>
			</div>
		</div>
	</div>
	
	<div class="modal fade" id="transpModal2D" tabindex="-1" role="dialog" aria-labelledby="dialogModalLabel" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<span class="modal-title">Change transparency</span>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body" id="transpBody2D" style="overflow: auto; max-height:600px; max-width:800px;">
					<select id="transpLayers2D">
						<option value="Tree">Tree</option>
						<option value="Building">Building</option>
						<option value="Podium">Podium</option>
						<option value="DOP">DOP</option>
					</select>
					<br /><br />
					Layer transparency:&nbsp;&nbsp;<input id="ex2" data-slider-id='ex1Slider' type="text" data-slider-min="0" data-slider-max="100" data-slider-step="1" data-slider-value="100"/>
				</div>
			</div>
		</div>
	</div>
	
	<div class="modal fade" id="reorderModal" tabindex="-1" role="dialog" aria-labelledby="dialogModalLabel" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<span class="modal-title">2D layer reorder</span>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body" id="reorderBody" style="overflow: auto; max-height:600px; max-width:800px;">
					<table id="layerReorderTable">
						<tr layerName="Tree">
							<td>Tree</td>
							<td><i class="fa fa-arrow-up fa-2x layerUp" aria-hidden="true" layerName="Tree"></i><i class="fa fa-arrow-down fa-2x layerDown" aria-hidden="true" layerName="Tree"></i></td>
						</tr>
						<tr layerName="Building">
							<td style="width:400px;">Building</td>
							<td><i class="fa fa-arrow-up fa-2x layerUp" aria-hidden="true" layerName="Building"></i><i class="fa fa-arrow-down fa-2x layerDown" aria-hidden="true" layerName="Building"></i></td>
						</tr>
						<tr layerName="Podium">
							<td>Podium</td>
							<td><i class="fa fa-arrow-up fa-2x layerUp" aria-hidden="true" layerName="Podium"></i><i class="fa fa-arrow-down fa-2x layerDown" aria-hidden="true" layerName="Podium"></i></td>
						</tr>
						<tr layerName="DOP">
							<td>DOP</td>
							<td><i class="fa fa-arrow-up fa-2x layerUp" aria-hidden="true" layerName="DOP"></i><i class="fa fa-arrow-down fa-2x layerDown" aria-hidden="true" layerName="DOP"></i></td>
						</tr>
					</table>
				</div>
			</div>
		</div>
	</div>
	
	<div class="modal fade" id="gltfModal" tabindex="-1" role="dialog" aria-labelledby="dialogModalLabel" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<span class="modal-title">gltf edit</span>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body" id="zoomToBody" style="overflow: auto; max-height:600px; max-width:800px;">
					<table class="table">
						<tr>
							<td style="width:300px;">Rotation:</td>
							<td><input id="exGLTFRotation" data-slider-id='ex1Slider' type="text" data-slider-min="0" data-slider-max="359" data-slider-step="5" data-slider-value="0"/></td>
						</tr>
						<tr>
							<td>Scale:</td>
							<td><input id="exGLTFScale" data-slider-id='ex1Slider' type="text" data-slider-min="1" data-slider-max="5" data-slider-step="0.2" data-slider-value="1"/></input></td>
						</tr>
					</table>
				</div>
			</div>
		</div>
	</div>
	
	<div class="modal fade" id="settingModal" tabindex="-1" role="dialog" aria-labelledby="dialogModalLabel" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<span class="modal-title">Scene settings</span>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body" id="identifyBody" style="overflow: auto; max-height:600px;">
					<form>
						<div class="form-group">
							<label>Identify layers:</label>
							<label class="form-check-label" style="margin:5px;">
								<input type="checkbox" class="form-check-input" id="checkBldg">
								bldg_wgs
							</label>
							
							<label class="form-check-label" style="margin:5px;">
								<input type="checkbox" class="form-check-input" id="checkPodium">
								podium_wgs
							</label>
							
							<label class="form-check-label" style="margin:5px;">
								<input type="checkbox" class="form-check-input" id="checkAAM">
								AAM_Model
							</label>
						</div>
						
						<div class="form-group">
							<label>Scene FOV</label>
							<select class="form-control col-xs-5" id="selectFOV" name="bfrSize">
								<option value="-1"> </option>
								<option value="30">30</option>
								<option value="50">50</option>
								<option value="80">80</option>
								<option value="100">100</option>
							</select>
						</div>
						
						<div class="form-group">
							<label>Split Screen Mode</label>
							<select class="form-control col-xs-5" id="selectSplit" name="bfrSize">
								<option value="0">None</option>
								<option value="1">Horizontal</option>
								<option value="2">Vertical</option>
								<option value="4">Triple</option>
								<option value="3">Quad</option>
							</select>
						</div>
						
						<button type="button" class="btn" data-dismiss="modal">Close</button>
					</form>
				</div>
			</div>
		</div>
	</div>
	
	<div class="modal fade" id="bufferModal" tabindex="-1" role="dialog" aria-labelledby="dialogModalLabel" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<span class="modal-title">Buffer analysis</span>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body"style="overflow: auto; max-height:600px; max-width:800px;">
					<!-- Should be a bootstrap form here
						including buffer mode: point, polyline, polygon, feature(building/application?)
						buffer size
						which layers involved in buffer analysis? -->
					<form id="bufferForm" class="form-horizontal">
						<fieldset id="bufferRadioGroup" class="form-group row">
							<label class="control-label col-xs-3" for="bfrType">Buffer type:</label>
							<div class="col-xs-5">
								<select class="form-control col-xs-5" id="bfrType" name="bfrSize">
									<option value="point">By Point</option>
									<option value="polyline">By Polyline</option>
									<option value="polygon">By Polygon</option>
									<option value="object">By Selected Feature</option>
								</select>
							</div>
						</fieldset>
						
						<div class="form-group">
							<label class="control-label col-xs-3" for="bfrSize">Buffer size (m):</label>
							<div class="col-xs-5"> 
								<input type="input" class="form-control" name="bfrSize" id="bfrSize" value="50">
							</div>
						</div>
						
						<fieldset id="bufferRadioGroup" class="form-group row">
							<label class="control-label col-xs-3" for="bfrLayer">Search in layer:</label>
							<div class="col-xs-5">
								<select class="form-control col-xs-5" id="bfrLayer" name="bfrLayer">
									<option value="Bldg_HK80">Building Vector</option>
									<option value="Lot">Lot</option>
									<option value="Application">Application</option>
								</select>
							</div>
						</fieldset>
						
						<button type="button" id="btnBufferSubmit" class="btn btn-primary" data-dismiss="modal">Submit</button>
						<button type="button" class="btn" data-dismiss="modal">Close</button>
					</form>
				</div>
			</div>
		</div>
	</div>
	
	<!--<div style="position:absolute; left:70px; top:35px; z-index:1003;">
		<input id="exDay" data-slider-id='ex1Slider' type="text" data-slider-min="14400" data-slider-max="100800" data-slider-step="1" data-slider-value="14400"/></input>
	</div>-->
	
	<div id="chart" style="width: 600px;height:400px;position: absolute;top: 0;left: 0;bottom : 0;right : 0;margin: auto;display: none;background-color: #ffffff"></div>
	
	<!-- Bootstrap table plugin javascripts -->
	<script src="lib/bootstrap-table/dist/bootstrap-table.js"></script>
	<script src="lib/bootstrap-slider/bootstrap-slider.min.js"></script>
    <script src="lib/bootstrap-table/ga.js"></script>
	<script src="lib/select2/js/select2.min.js"></script>
	<script src="lib/bootstrap-table/dist/extensions/select2-filter/bootstrap-table-select2-filter.js"></script>
	<script src="lib/bootstrap-table/dist/extensions/export/bootstrap-table-export.js"></script>
	<script src="lib/bootstrap-table/dist/tableExport.js"></script>
	
	<!-- Cesium and layer manager initiation -->
	<script>
		var host = document.location.host;
		var protocol = document.location.protocol;
		var handler;
		var threeDGIS;		// This should be the core part of all the system views
		var map;
		var dopLayer;
		
		if(host == "")
		{
			host = protocol+"//localhost:8090";
		}
		else
		{
			host = protocol+"//" + host;
		}
		
		// Some hard code. Pay attention on how to fix this
		// Hard code on 2D map url, using Phase 1 map
		var mapUrl = host + "/iserver/services/map-PlanD_Phase1/rest/maps/Map";
		var handlerPolygon, computeBuffer;
		
		// Hard code on terrain URL for profile analysis
		var profileUrl = host+ '/iserver/services/spatialAnalysis-Phase2_Data/restjsr/spatialanalyst/datasets/HK_DTM_80@10.40.106.82_P2_Sample_Data/terraincalculation/profile.jsonp?returnContent=true';
		
		function onload(Cesium) {
			// Class initiation
			// alert('Logged in as <%=session.getAttribute( "USER_ID") %>  ( <%=session.getAttribute( "USER_POST") %>)');
			
			try
			{
				var viewer = new Cesium.Viewer('cesiumContainer',{
					imageryProvider:new Cesium.SingleTileImageryProvider({
						url : '../iClient/for3D/webgl/examples/images/worldimage.jpg'
					}),
					/*imageryProvider :  new Cesium.BingMapsImageryProvider({
						key : "AjQhMyw76oicHqFz7cUc3qTEy3M2fC2YIbcHjqgyMPuQprNVBr3SsvVdOfmlVc0v",//????(https://www.bingmapsportal.com/)??key
						url : URL_CONFIG.BINGMAP
					}),*/
					terrainProvider : new Cesium.CesiumTerrainProvider({
						url: host+'/iserver/services/3D-Phase2_Data/rest/realspace/datas/HK_DTM_1@dem',
						isSct: true
					}),
					shadows: true,
					contextOptions: {
						webgl:{preserveDrawingBuffer:true}
					}
					// sceneMode : Cesium.SceneMode.COLUMBUS_VIEW		// 2D scene, but not seem to solve coordinate system?
				});
				
				viewer.scene.globe.enableLighting = true;
				// viewer.scene.globe.shadows = Cesium.ShadowMode.ENABLED;	// Does not seem to make any difference
			}
			catch(e)
			{
				// Remove the catch statement
				;//location.reload();
			}
			
			handlerPolygon = new Cesium.DrawHandler(viewer,Cesium.DrawMode.Polygon);
			computeBuffer = function(result){
				var polygon = result.object.polygon;
				var point2Ds = [];
				
				if(polygon.hierarchy)
				{
					var hierarchy = polygon.hierarchy.getValue();
					
					for(var i=0; i<hierarchy.length; i++)
					{
						var cartographic = Cesium.Cartographic.fromCartesian(hierarchy[i]);
						var hkpt = CoordTransform.wgs2hk(cartographic.longitude*180/Math.PI, cartographic.latitude*180/Math.PI);
						point2Ds.push(new SuperMap.Geometry.Point(hkpt[0], hkpt[1]));
					}
					var linearRings = new SuperMap.Geometry.LinearRing(point2Ds);
					var region = new SuperMap.Geometry.Polygon([linearRings]);
				}
				else
					region = polygon;
				
				var selectedFeatureProcessCompleted = function(e)
				{
					var features = e.result.features;
					ThreeDGIS.rewriteAttributeTable(features);
					
					$('#iconAttributeTable').click();
					
					var layerBldgVec = viewer.scene.layers.find('bldg_wgs');
					layerBldgVec.releaseSelection();
					var selectedIDs = [];
					for(var i=0; i<features.length; i++)
						selectedIDs.push(Number(features[i].data["SMID"]));
						
					layerBldgVec.setSelection(selectedIDs);
				}
				
				var processFailed = function(e){console.log('Buffer not successful');}
				
				var getFeaturesByGeometryParams = new SuperMap.REST.GetFeaturesByBufferParameters({
					datasetNames: ["10.40.106.82_P2_Sample_Data:Bldg_HK80"],		// Using hardcode
					bufferDistance: Number($('#bfrSize').val()),
					geometry: region,
					toIndex:9999
				});
				var getFeaturesByGeometryService = new SuperMap.REST.GetFeaturesByBufferService(host+'/iserver/services/data-Phase2_Data/rest/data/', {
					eventListeners: {
						"processCompleted": selectedFeatureProcessCompleted,
						"processFailed": processFailed
					}
				});
				getFeaturesByGeometryService.processAsync(getFeaturesByGeometryParams);
				
				var bufferAnalystCompleted = function(args) {
					if(args){
						var bufferResultGeometry = args.result.resultGeometry;
						var hkVertices = bufferResultGeometry.getVertices();
						
						// Convert the HK80 coordinate of the vertices to WGS84 and then plot out
						var wgsVertices = [];
						for(var i=0; i<hkVertices.length; i++)
						{
							var wgspt = CoordTransform.hk2wgs(hkVertices[i].x, hkVertices[i].y);
							wgsVertices.push(Cesium.Cartesian3.fromDegrees(wgspt[0],wgspt[1]));
						}
						
						var polygon = new Cesium.PolygonGraphics({
							hierarchy: new Cesium.PolygonHierarchy(wgsVertices),
							material: new Cesium.Color(1.0, 0.2, 0.6, 0.7),
							outline: true,
							outlineColor : Cesium.Color.BLACK,
						});
						
						threeDGIS.threeDView.viewer.entities.add({
							id: 'buffer',
							polygon: polygon,
							outline: true,
							shadows: Cesium.ShadowMode.ENABLED		// Does not seem to be working
						});
					}
				}
				
				var bufferServiceByGeometry = new SuperMap.REST.BufferAnalystService(host+'/iserver/services/spatialAnalysis-Phase2_Data/restjsr/spatialanalyst'),
                        bufferDistance = new SuperMap.REST.BufferDistance({
                            value: Number($('#bfrSize').val())
                        }),
                        bufferSetting = new SuperMap.REST.BufferSetting({
                            endType: SuperMap.REST.BufferEndType.ROUND,
                            leftDistance: bufferDistance,
                            rightDistance: bufferDistance,
                            semicircleLineSegment: 20
                        }),
                        geoBufferAnalystParam = new SuperMap.REST.GeometryBufferAnalystParameters({
                            sourceGeometry: region,
                            bufferSetting: bufferSetting
                        });

                bufferServiceByGeometry.events.on({"processCompleted": bufferAnalystCompleted});
                bufferServiceByGeometry.processAsync(geoBufferAnalystParam);
				
				// thisObj.pointBufferFlag = false;
			}
			
			var camera = viewer.scene.camera;
			camera.setView({
				destination: new Cesium.Cartesian3(-2421447.656,5394336.298,2416998.154),
				orientation: {
					heading : 0,
					pitch : -1.047,
					roll : 0.0
				}
			});
			
			threeDGIS = new ThreeDGIS(
				new ThreeDView(viewer,$('#cesiumContainer'),$('#toolset3D')),
				new TwoDView(null,$('#SMapContainer'),$('#toolset2D')),
				$('#streetViewContainer'),		// Whether to make this a class (contain other functionality?)
				null		// Not implemented
			);
			
			// Use a polygon to perform buffer
			handlerPolygon.drawEvt.addEventListener(threeDGIS.threeDView.computeBuffer);

			var imageryLayers = viewer.imageryLayers;
			var imageryProvider = new Cesium.SuperMapImageryProvider({
				url: host+'/iserver/services/3D-Phase2_Data/rest/realspace/datas/dop5k201555402_1@data'
				//url: host+'/iserver/services/map-OZP_ZONE/rest/maps/OZP_ZONE_WGS84'
			});

			dopLayer = imageryLayers.addImageryProvider(imageryProvider);
			
			var scene = viewer.scene;
			var widget = viewer.cesiumWidget;
			
			var rectangleInstance = new Cesium.GeometryInstance({
			  geometry : new Cesium.RectangleGeometry({
				rectangle : Cesium.Rectangle.fromDegrees(114.14, 22.28, 114.35, 22.4)
			  }),
			  id : 'rectangle',
			  attributes : {
				color : new Cesium.ColorGeometryInstanceAttribute(0.0, 1.0, 1.0, 0.5)
			  }
			});
			scene.primitives.add(new Cesium.GroundPrimitive({
			  geometryInstance : rectangleInstance
			}));
			
			setTimeout(function() {
				try{
					//??S3M??
					// var ground1Promise = scene.addS3MTilesLayerByScp(URL_CONFIG.SCP_CBD_GROUND1,{name : 'ground1'});
					var buildPromise = scene.addS3MTilesLayerByScp(host+'/iserver/services/3D-Phase2_Data/rest/realspace/datas/Bldg@model/config',{
						name : 'bldg_wgs'
					});
					var podiumPromise = scene.addS3MTilesLayerByScp(host+'/iserver/services/3D-Phase2_Data/rest/realspace/datas/Podium@model/config',{
						name : 'podium_wgs'
					});
					var aamModelPromise = scene.addS3MTilesLayerByScp(host+'/iserver/services/3D-Phase2_Data/rest/realspace/datas/AAM_Model@model/config',{
						name : 'AAM_Model'
					});
					var polyuPromise = scene.addS3MTilesLayerByScp(host+'/iserver/services/3D-PlanD_Phase1/rest/realspace/datas/Config/config',{
						name : 'PolyU'
					});
					var cyberPortPromise = scene.addS3MTilesLayerByScp(host+'/iserver/services/3D-OSGB_Trial/rest/realspace/datas/CyperPort_s3m/config',{
						name : 'cyber_port'
					});
					var taikooshingPromise = scene.addS3MTilesLayerByScp(host+'/iserver/services/3D-OSGB_Trial/rest/realspace/datas/TaiKooShing_s3m/config',{
						name : 'TaiKooShing'
					});
					var saikungPromise = scene.addS3MTilesLayerByScp(host+'/iserver/services/3D-OSGB_Trial/rest/realspace/datas/SaiKung_s3m/config',{
						name : 'SaiKung'
					});
					
					var promiseSet = [podiumPromise, buildPromise, aamModelPromise, polyuPromise, cyberPortPromise, taikooshingPromise, saikungPromise];
					Cesium.when.all(promiseSet,function(layer){
						var viewer = threeDGIS.viewer3D;
						viewer.scene.layers.find('AAM_Model').selectedColor = new Cesium.Color(1,0,1);
						viewer.scene.layers.find('bldg_wgs').selectedColor = new Cesium.Color(1,0,1);
						
						// Read to determine which layers are OSGB
						viewer.scene.layers.find('AAM_Model').lodRangeScale = 0.4;
						viewer.scene.layers.find('PolyU').lodRangeScale = 0.4;
						viewer.scene.layers.find('cyber_port').lodRangeScale = 0.4;
						viewer.scene.layers.find('TaiKooShing').lodRangeScale = 0.4;
						viewer.scene.layers.find('SaiKung').lodRangeScale = 0.4;
						
						var layerBldgVec = viewer.scene.layers.find('bldg_wgs');
						var layerPodiumVec = viewer.scene.layers.find('podium_wgs');
						var layerAAM = viewer.scene.layers.find('AAM_Model');
						
						layerBldgVec._bReleaseColor = false;
						layerPodiumVec._bReleaseColor = false;
						layerBldgVec.refresh();
						layerPodiumVec.refresh();
						
						/*layerBldgVec.setQueryParameter({
							url: host+'/iserver/services/data-Phase2_Data/rest/data',
							dataSourceName: '10.40.106.82_P2_Sample_Data',
							dataSetName: 'Bldg_HK80',
							keyWord: 'SmID'
						});
						
						layerPodiumVec.setQueryParameter({
							url: host+'/iserver/services/data-Phase2_Data/rest/data',
							dataSourceName: '10.40.106.82_P2_Sample_Data',
							dataSetName: 'Podium_HK80',
							keyWord: 'SmID'
						});
						
						layerAAM.setQueryParameter({
							url: host+'/iserver/services/data-Phase2_Data/rest/data',
							dataSourceName: '10.40.106.82_P2_Sample_Data',
							dataSetName: 'AAM_Model',
							keyWord: 'SmID'
						});*/
					},function(e){
						if (widget._showRenderLoopErrors) {
							var title = '??SCP??,???????????url???????';
							widget.showErrorPanel(title, undefined, e);
						}
					});
				}
				catch(e){
					if (widget._showRenderLoopErrors) {
						var title = 'An error occurred while rendering.  Rendering has stopped.';
						widget.showErrorPanel(title, undefined, e);
					}
				}
			},3000);

			// These should be UI matters, but need to wait for Cesium to be initialized
			// Checked list initiate
			$('.list-group.checked-list-box .list-group-item').each(function () {
				// Settings
				var $widget = $(this),
				$checkbox = $('<input type="checkbox" class="hidden" id="'+$widget.html()+'" />'),
				color = ($widget.data('color') ? $widget.data('color') : "primary"),
				style = ($widget.data('style') == "button" ? "btn-" : "list-group-item-"),
				settings = {
					on: {
						icon: 'glyphicon glyphicon-check'
					},
					off: {
						icon: 'glyphicon glyphicon-unchecked'
					}
				};
				
				$widget.css('cursor', 'pointer')
				$widget.append($checkbox);

				// Event Handlers
				$widget.on('click', function () {
					$checkbox.prop('checked', !$checkbox.is(':checked'));
					$checkbox.triggerHandler('change');
					// updateDisplay();
				});
				$checkbox.on('change', function () {
					updateDisplay();
				});
				  
				// Actions
				function updateDisplay() {
					var layerName = $checkbox[0].id;
					var isChecked = $checkbox.is(':checked');
					var viewer = threeDGIS.viewer3D;

					// Set the button's state
					$widget.data('state', (isChecked) ? "on" : "off");

					// Set the button's icon
					$widget.find('.state-icon')
						.removeClass()
						.addClass('state-icon ' + settings[$widget.data('state')].icon);

					// Currently hard code to determine different layer types. Maybe dividing these will be necessary
					if(layerName=='Base_Map')
					{
						if(isChecked)
						{
							/*var imageryLayers = viewer.imageryLayers;
							var imageryProvider = new Cesium.SuperMapImageryProvider({
								//url: host+'/iserver/services/3D-Phase2_Data/rest/realspace/datas/dop5k201555402_1@data'
								url: host+'/iserver/services/map-BaseMap_Color/rest/maps/Basemap_Small'
							});
							
							var layer = imageryLayers.addImageryProvider(imageryProvider);*/
							
							var provider = new Cesium.ArcGisMapServerImageryProvider({
								url : 'https://pld-gisweb.pland.hksarg/arcgis/rest/services/Basemap/BMS_COLOR_WM/MapServer'
							});

							var layer = viewer.imageryLayers.addImageryProvider(provider);
							layer.name = "Base_Map";
							
							for(var i=0; i<viewer.imageryLayers.length; i++)
							{
								if(viewer.imageryLayers.get(i).name=='OZP_Zone')
								{
									viewer.imageryLayers.raiseToTop(viewer.imageryLayers.get(i));
									break;
								}
							}
						}
						else
						{
							for(var i=0; i<viewer.imageryLayers.length; i++)
							{
								if(viewer.imageryLayers.get(i).name=='Base_Map')
									viewer.imageryLayers.remove(viewer.imageryLayers.get(i));
							}
						}
					}
					else if(layerName=='OZP_Zone')
					{
						if(isChecked)
						{
							/*var imageryLayers = viewer.imageryLayers;
							var imageryProvider = new Cesium.SuperMapImageryProvider({
								//url: host+'/iserver/services/3D-Phase2_Data/rest/realspace/datas/dop5k201555402_1@data'
								url: host+'/iserver/services/map-BaseMap_Color/rest/maps/Basemap_Small'
							});
							
							var layer = imageryLayers.addImageryProvider(imageryProvider);*/
							
							var imageryLayers = viewer.imageryLayers;
							var imageryProvider = new Cesium.SuperMapImageryProvider({
								url: host+'/iserver/services/map-OZP_ZONE/rest/maps/OZP_ZONE_WGS84'
								// url: host+'/iserver/services/map-Phase2_Data/rest/maps/SPOT_NIR'		// Map including image on DB not served right?
							});
							
							var ozpLayer = imageryLayers.addImageryProvider(imageryProvider);
							imageryLayers.raiseToTop(ozpLayer);
							ozpLayer.name = "OZP_Zone";
						}
						else
						{
							for(var i=0; i<viewer.imageryLayers.length; i++)
							{
								if(viewer.imageryLayers.get(i).name=='OZP_Zone')
								{
									viewer.imageryLayers.remove(viewer.imageryLayers.get(i));
									break;
								}
							}
						}
					}
					else if(layerName=='SPOT_RGB')
					{
						if(isChecked)
						{							
							var imageryLayers = viewer.imageryLayers;
							var imageryProvider = new Cesium.SuperMapImageryProvider({
								url: host+'/iserver/services/map-Phase2_Data/rest/maps/SPOT_RGB'
							});
							
							var spotLayer = imageryLayers.addImageryProvider(imageryProvider);
							spotLayer.name = "SPOT_RGB";
						}
						else
						{
							for(var i=0; i<viewer.imageryLayers.length; i++)
							{
								if(viewer.imageryLayers.get(i).name=='SPOT_RGB')
								{
									viewer.imageryLayers.remove(viewer.imageryLayers.get(i));
									break;
								}
							}
						}
					}
					else if(layerName=='Lot_Map')
					{
						if(isChecked)
						{							
							var imageryLayers = viewer.imageryLayers;
							var imageryProvider = new Cesium.SuperMapImageryProvider({
								url: host+'/iserver/services/map-OZP_ZONE/rest/maps/Lot_WGS84'
							});
							
							var spotLayer = imageryLayers.addImageryProvider(imageryProvider);
							spotLayer.name = "Lot_Map";
						}
						else
						{
							for(var i=0; i<viewer.imageryLayers.length; i++)
							{
								if(viewer.imageryLayers.get(i).name=='Lot_Map')
								{
									viewer.imageryLayers.remove(viewer.imageryLayers.get(i));
									break;
								}
							}
						}
					}
					else if(layerName=='Terrain')
					{
						if(isChecked)
						{
							viewer.terrainProvider = new Cesium.CesiumTerrainProvider({
								url : host+'/iserver/services/3D-Phase2_Data/rest/realspace/datas/HK_DTM_1@dem',
								isSct : true
							});
						}
						else
						{
							viewer.terrainProvider = new Cesium.EllipsoidTerrainProvider({});
						}
					}
					else
					{
						var layerToTrigger = viewer.scene.layers.find(layerName);
						if(layerToTrigger)
						{
							if(threeDGIS.mode.length==1)
								layerToTrigger.visible = isChecked;
							else if(threeDGIS.mode[0]=='3D' || threeDGIS.mode[1]=='3D')
								layerToTrigger.setVisibleInViewport(0, isChecked);
						}
					}
					
					var mode = threeDGIS.mode[0];
					if(mode=='2D')
					{
						var layer = threeDGIS.twoDView.map.getLayersByName(layerName);
						layer[0].setVisibility(isChecked);
					}
					// Update the button's color
					// Not implement this yet
					/*if (isChecked) {
						//$widget.addClass(style + color + ' active');
						
					} else {
						//$widget.removeClass(style + color + ' active');
					}*/
				}

				// Initialization
				function init() {
					
					if ($widget.data('checked') == true) {
						$checkbox.prop('checked', !$checkbox.is(':checked'));
					}
					
					updateDisplay();

					// Inject the icon if applicable
					if ($widget.find('.state-icon').length == 0) {
						$widget.prepend('<span class="state-icon ' + settings[$widget.data('state')].icon + '"></span>');
					}
				}
				init();
			});
			
			initBookmark();
			
			var skyline = new Cesium.Skyline(scene);
			
			$("#btnSkyline").click(function () {
				var viewer = threeDGIS.viewer3D;
				var scene = viewer.scene;
				var cartographic = scene.camera.positionCartographic;
				var longitude = Cesium.Math.toDegrees(cartographic.longitude);
				var latitude = Cesium.Math.toDegrees(cartographic.latitude);
				var height = cartographic.height;

				skyline.viewPosition = [longitude, latitude, height];
				
				skyline.pitch = Cesium.Math.toDegrees(scene.camera.pitch);
				skyline.direction = Cesium.Math.toDegrees(scene.camera.heading);
				skyline.build();
			});
			
			// Viewshed analysis
			var viewPosition;

			// scene.viewFlag = true;
			var pointHandler = new Cesium.PointHandler(viewer);
			threeDGIS.threeDView.pointHandler = pointHandler;

			var viewshed3D = new Cesium.ViewShed3D(scene);
			threeDGIS.threeDView.viewshed = viewshed3D;
			/*var handler = new Cesium.ScreenSpaceEventHandler(scene.canvas);

			handler.setInputAction(function(e){
				if (!scene.viewFlag) {
					var position = e.endPosition;
					var last = scene.pickPosition(position);

					var distance = Cesium.Cartesian3.distance(viewPosition, last);

					if(distance > 0 ){
						var cartographic = Cesium.Cartographic.fromCartesian(last);
						var longitude = Cesium.Math.toDegrees(cartographic.longitude);
						var latitude = Cesium.Math.toDegrees(cartographic.latitude);
						var height = cartographic.height;

						viewshed3D.setDistDirByPoint([longitude, latitude, height]);
					}
				}
			},Cesium.ScreenSpaceEventType.MOUSE_MOVE);

			handler.setInputAction(function(e){
				scene.viewFlag = true;
				// pointHandler.deactivate();
			},Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK);*/

			$("#btnViewshed").click(function() {
				threeDGIS.threeDView.removeAnalysisEntities();
				var viewer = threeDGIS.viewer3D;
				threeDGIS.threeDView.analysisFlag = true;
				
				if(threeDGIS.threeDView.pointHandler.active) {
					// threeDGIS.threeDView.pointHandler.deactivate();
					return;
				}

				// viewer.entities.removeAll();
				var entityValues = viewer.entities.values;
				/*for(var i=entityValues.length-1; i>-1; i--)
				{
					var id = entityValues[i].id;
					if(id.substring(0,5)!='BLOCK')
						viewer.entities.remove(entityValues[i]);
					
					threeDGIS.threeDView.removeAllLabels();
				}*/
				threeDGIS.threeDView.removeAnalysisEntities();

				threeDGIS.threeDView.viewshed.distance = 400;
				scene.viewFlag = true;

				threeDGIS.threeDView.pointHandler.activate();
			});
			
			$('#btnSetScale2D').click(function (){
				var scaleString = prompt('Input scale:');
				
				if($.isNumeric(scaleString))
				{
					var scaleNum = Number(scaleString);
					
					threeDGIS.twoDView.map.zoomToScale(scaleNum);
				}
				else
				{
					var scaleSplit = scaleString.split(':');
					if($.isNumeric(scaleSplit[0]) && $.isNumeric(scaleSplit[1]) && scaleSplit.length==2)
					{
						var scaleNum = Number(scaleSplit[0])/Number(scaleSplit[1]);
						threeDGIS.twoDView.map.zoomToScale(scaleNum);
					}
					else
						// Alert input error
						alert('Input not a number');
				}
			});

			pointHandler.drawCompletedEvent.addEventListener(function(point){
				var position = point.position._value;
				threeDGIS.threeDView.viewPosition = position;

				var cartographic = Cesium.Cartographic.fromCartesian(position);
				var longitude = Cesium.Math.toDegrees(cartographic.longitude);
				var latitude = Cesium.Math.toDegrees(cartographic.latitude);
				var height = cartographic.height;

				if(scene.viewFlag) {
					threeDGIS.threeDView.viewshed.viewPosition = [longitude, latitude, height+2.5];
					threeDGIS.threeDView.viewshed.build();
					scene.viewFlag = false;
				}
			});
			
			// Switch to walk mode and shortcut key for fly
			// Not implementing this before reconstructing the code into classes
			$('#btnWalkmode').click(function() {
				threeDGIS.toggleViewMode3D();
				if($('#btnStreetView').parent().css('display')=='block')
					$('#btnStreetView').parent().css('display','none');
				else
					$('#btnStreetView').parent().css('display','block');
					
				// movementCtrl.toggle();
			})
			
			initProfile();
			
			// Write this upon attribute appear, not on initialize of cesium
			initAttributeTable();
			
			// Fly to function
			$('#btnFlyTo').click(function() {
				// Validate input not implemented
				if(isNaN($('#txtLng').val()))
				{
					alert('Longitude input not number');
					return;
				}
				if(isNaN($('#txtLat').val()))
				{
					alert('Longitude input not number');
					return;
				}
				if(isNaN($('#txtHeight').val()))
				{
					alert('Longitude input not number');
					return;
				}
				if(isNaN($('#txtHead').val()))
				{
					alert('Longitude input not number');
					return;
				}
				if(isNaN($('#txtTilt').val()))
				{
					alert('Longitude input not number');
					return;
				}
				
				var hkx = Number($('#txtLng').val());
				var hky = Number($('#txtLat').val());
				var height = Number($('#txtHeight').val());
				var head = Number($('#txtHead').val())*Math.PI/180;
				var tilt = -Number($('#txtTilt').val())*Math.PI/180;
				
				var wgspt = CoordTransform.hk2wgs(hkx, hky);
				
				threeDGIS.threeDView.viewer.scene.camera.flyTo({
					destination: Cesium.Cartesian3.fromDegrees(wgspt[0],wgspt[1],height),
					orientation: {
						heading: head,
						pitch: tilt,
						roll: 0
					},
					duration: 2
				});
			});
			
			var transpSlider = $('#ex1').bootstrapSlider({
				formatter: function(value) {
					return value + '%';
				}
			});
			var blockSlider = $('#exBlockHeight').bootstrapSlider({
				formatter: function(value) {
					return value + 'm';
				}
			});
			$('#exBlockHeight').bootstrapSlider("disable");
			
			transpSlider.bootstrapSlider('on','slideStop',function(val) {
				var selectedLayer = $('#transpLayers').val();
				if(selectedLayer=='Base_Map' || selectedLayer=='OZP_Zone' || selectedLayer=='SPOT_RGB' || selectedLayer=='Lot_Map')
				{
					for(var i=0; i<threeDGIS.threeDView.viewer.imageryLayers.length; i++)
					{
						if(threeDGIS.threeDView.viewer.imageryLayers.get(i).name=='OZP_Zone')
						{
							threeDGIS.threeDView.viewer.imageryLayers.get(i).alpha = val/100;
							break;
						}
					}
				}
				else
				{
					var layer = threeDGIS.threeDView.viewer.scene.layers.find(selectedLayer);
					layer.style3D.fillForeColor.alpha = val/100;
					layer.refresh();
				}
			});
			
			blockSlider.bootstrapSlider('on','change',function(val) {
				threeDGIS.threeDView.updateHeight(val.newValue);
				
				var areaStr = $('#txtArea').html();
				$('#txtHt').html(val.newValue + ' m');
				var floorNo = Math.floor(val.newValue/3);
				$('#txtNoFloor').html(Number(floorNo));
				
				areaStr = areaStr.substring(0,areaStr.length-4);
				var area = Number(areaStr);
				
				$('#txtGFA').html(Number(area*floorNo).toFixed(3));
			});
			
			blockSlider.bootstrapSlider('on','slideStop',function() {
				threeDGIS.threeDView.addModifyList();
			});
			
			$('#transpLayers').change(function(e) {
				var selectedLayer = $('#transpLayers').val();
				var alpha = 0;
				if(selectedLayer=='Base_Map')
				{
					alpha = threeDGIS.threeDView.viewer.imageryLayers.get(2).alpha;
				}
				else
				{
					var layer = threeDGIS.threeDView.viewer.scene.layers.find(selectedLayer);
					alpha = layer.style3D.fillForeColor.alpha;
				}
				
				transpSlider.bootstrapSlider('setValue',alpha*100);
			});
			
			// Transp for 2D
			var transpSlider2D = $('#ex2').bootstrapSlider({
				formatter: function(value) {
					return value + '%';
				}
			});
			transpSlider2D.bootstrapSlider('on','slideStop',function(val) {
				var selectedLayer = $('#transpLayers2D').val();
				var layer = threeDGIS.twoDView.map.getLayersByName(selectedLayer);
				layer[0].setOpacity(val/100);
			});
			
			$('#transpLayers2D').change(function(e) {
				var selectedLayer = $('#transpLayers2D').val();
				var layer = threeDGIS.twoDView.map.getLayersByName(selectedLayer);
				
				//transpSlider2D.bootstrapSlider('setValue',layer[0].opacity*100);		// 2D map cannot get opacity for layers???
				transpSlider2D.bootstrapSlider('setValue',100);
			});
			
			var gltfRotationSlider = $('#exGLTFRotation').bootstrapSlider({
				formatter: function(value) {
					return value + ' deg';
				}
			});
			
			gltfRotationSlider.bootstrapSlider('on','change',function(val) {
				var viewer = threeDGIS.threeDView.viewer;
				var entity = viewer.entities.getById('model_gltf');
				
				entity.orientation = Cesium.Transforms.headingPitchRollQuaternion(
					entity.position.getValue(new Cesium.JulianDate()), 
					new Cesium.HeadingPitchRoll(val.newValue*Math.PI/180, 0, 0)
				);
			});
			
			var gltfScaleSlider = $('#exGLTFScale').bootstrapSlider();
			
			gltfScaleSlider.bootstrapSlider('on','change',function(val) {
				var viewer = threeDGIS.threeDView.viewer;
				var entity = viewer.entities.getById('model_gltf');
				
				entity.model.scale = val.newValue;
			});
			
			/*var daySlider = $('#exDay').bootstrapSlider({
				formatter: function(value) {
					var sec = value-3600*4, secLeft;
					var hour = Math.floor(sec/3600);
					secLeft = sec - hour*3600;
					var min = Math.floor(secLeft/60);
					sec = secLeft - min*60;
					
					return hour+':'+min+':'+sec;
				}
			});
			
			daySlider.bootstrapSlider('on','change',function(val) {
				var viewer = threeDGIS.threeDView.viewer;
				viewer.clock.currentTime.secondsOfDay = val.newValue;
			});*/
			
			function initReorderButton() {
				$('.layerUp').click(function() {
					var layerName = this.getAttribute("layerName");
					
					var map = threeDGIS.twoDView.map;
					var layer = map.getLayersByName(layerName)[0];
					map.raiseLayer(layer,1);
					adjustListOrder();
				});
				
				$('.layerDown').click(function() {
					var layerName = this.getAttribute("layerName");
					
					var map = threeDGIS.twoDView.map;
					var layer = map.getLayersByName(layerName)[0];
					map.raiseLayer(layer,-1);
					adjustListOrder();
				});
			}
			initReorderButton();
			
			function adjustListOrder() {
				var map = threeDGIS.twoDView.map;
				var layers = map.layers;
				
				var table = $('#layerReorderTable');
				var tableRows = table.find('tr').get();
				
				$('#layerReorderTable tr').remove();
				var tableHTML = '';
				for(var i=0; i<layers.length; i++)
				{
					var lyrName = layers[i].name;
					var row;
					
					for(var j=0; j<layers.length; j++)
					{
						if(tableRows[j].getAttribute('layerName')==lyrName)
						{
							row = tableRows[j];
							break;
						}
					}
					table.children('tbody').prepend(row);
					//tableHTML += row;
				}
				//table.html(tableHTML);\
				initReorderButton();
			}
			
			function loadBlock()
			{
				fields = [];
				var getFeatureParam, getFeatureBySQLService, getFeatureBySQLParams;

				getFeatureParam = new SuperMap.REST.FilterParameter({
					attributeFilter: "SMID > -1"
				});
				getFeatureBySQLParams = new SuperMap.REST.GetFeaturesBySQLParameters({
					queryParameter: getFeatureParam,
					// datasetNames:["SQLServerSource:"+layerNameSplit[0]],	// Currently hardcode the datasource first
					datasetNames:["SQLServerSource:Proposed_Building"],
					toIndex:999999
				});
				getFeatureBySQLService = new SuperMap.REST.GetFeaturesBySQLService(host + '/iserver/services/data-PlanD_Phase1/rest/data', {
					eventListeners: {"processCompleted": getBlockCompleted, "processFailed": processFailed}
				});

				getFeatureBySQLService.processAsync(getFeatureBySQLParams);
			}
			
			function getBlockCompleted(getFeaturesEventArgs)
			{
				var i, len, features, feature, result = getFeaturesEventArgs.result;
				if (result && result.features) {
					features = result.features;

					for(var i=0; i<features.length; i++)
					{
						
						var feature = features[i];
						var vertices = feature.geometry.getVertices();
						
						var id = feature.data.SMID;
						var baseHeight = Number(feature.data.BASEHEIGHT);
						var extrudeHeight = Number(feature.data.ELEVATION);
						var blockName = feature.data.BLOCKNAME;
						
						var verticesCartesian = [];
						
						for(var j=0; j<vertices.length; j++)
						{
							var y = vertices[j].y;
							var x = vertices[j].x;
							
							/*var wgspt = CoordTransform.hk2wgs(x,y);
							
							var cartesian = Cesium.Cartesian3.fromDegrees(wgspt[0], wgspt[1], baseHeight);
							verticesCartesian.push(cartesian);*/
							
							verticesCartesian.push(CoordTransform.hk2cartesian(x,y,baseHeight));
						}
						
						var tbk = new ThreeDBlock({
							vertices: verticesCartesian,
							extrudeHeight: extrudeHeight,
							blockName: blockName,
							id: id,
							viewer: viewer
						});
					}
				}
			}
			
			loadBlock();
		}
	</script>
  
	<!-- UI scripts -->
	<script>
		// Test, to make div draggable
		function startMove(initX, initY, prevX, prevY) {
			$('.movable').on('mousemove', function(event) {
				var thisX = event.pageX - initX;
					thisY = event.pageY - initY;

				$('.movable').offset({
					left: thisX + prevX,
					top: thisY + prevY
				});
			});
		}
		
		$(document).ready(function() {
			var $table = $('#attributeTable');

			$('#dialogModal').on('shown.bs.modal', function () {
				$table.bootstrapTable('resetView');
			});
		
			$("#dialogModal").find(".modal-header").on('mousedown', function(event) {
				$("#dialogModal").addClass('movable');

				var initX = event.pageX;
				var initY = event.pageY;
				
				var lp = $('#dialogModal').css('left');
				var tp = $('#dialogModal').css('top');
				if(!$.isNumeric(lp))
					lp = lp.substring(0,lp.length-2);
				if(!$.isNumeric(tp))
					tp = tp.substring(0,tp.length-2);
					
				var prevX = Number(lp);
				var prevY = Number(tp);
				
				startMove(initX, initY, prevX, prevY);
			});
			
			$(document).on('mouseup', function() {
				$('.movable').off('mousemove');
				$('.movable').removeClass('movable');
			});
			
			var clientWidth = $(window).width();
			var clientHeight = $(window).height();
			
			resizeElement();
			$('[data-toggle="tooltip"]').tooltip();   
			$('#iconLayerManager').on('click', function() {
				$('#btnLayerManager').click();
				var layerManagerLocLeft = $('.sidebar-left').css('left');
					
				if(layerManagerLocLeft == '0px')
				{
					$('.sidebar-left').css('left','50px');
				}
				else
				{
					$('.sidebar-left').css('left','0px');
				}
			});
			
			$('#iconAttributeTable').on('click', function() {
				$('#btnAttributeTable').click();
			});
			
			// This makes popup unclickable...
			$("#btnAttributeTable").on('shown.bs.modal',function(){
				$(document).off('focusin.bs.modal');
			});
			
			$('#iconFlyTo').on('click', function() {
				$('#btnFlyToTrigger').click();
				
				var camera = threeDGIS.threeDView.viewer.scene.camera;
				var cameraCarto = Cesium.Cartographic.fromCartesian(camera.position);
				
				var hkpt = CoordTransform.wgs2hk(cameraCarto.longitude*180/Math.PI, cameraCarto.latitude*180/Math.PI);
				
				$('#txtLng').val(hkpt[0].toFixed(3));
				$('#txtLat').val(hkpt[1].toFixed(3));
				$('#txtHeight').val((cameraCarto.height).toFixed(3));
				$('#txtHead').val((camera.heading*180/Math.PI).toFixed(3));
				$('#txtTilt').val((-camera.pitch*180/Math.PI).toFixed(3));
			});
			
			$("#btnFlyToTrigger").on('shown.bs.modal',function(){
				$(document).off('focusin.bs.modal');
			});
			
			
			$('#iconTransp').on('click', function() {
				$('#btnTranspTrigger').click();
			});
			
			// This makes popup unclickable...
			$("#btnTranspTrigger").on('shown.bs.modal',function(){
				$(document).off('focusin.bs.modal');
			});
			
			$('#iconTransp2D').on('click', function() {
				$('#btnTranspTrigger2D').click();
			});
			
			// This makes popup unclickable...
			$("#btnTranspTrigger2D").on('shown.bs.modal',function(){
				$(document).off('focusin.bs.modal');
			});
			
			$('#iconLayerReorder').on('click', function() {
				$('#btnLayerReorder').click();
			});
			
			// This makes popup unclickable...
			$("#btnLayerReorder").on('shown.bs.modal',function(){
				$(document).off('focusin.bs.modal');
			});
			
			$('#iconZoomTo').on('click', function() {
				$('#btnZoomTo').click();
				
				var mapCenter = threeDGIS.twoDView.map.getCenter();
				$('#txtEasting').val(mapCenter.lon.toFixed(3));
				$('#txtNorthing').val(mapCenter.lat.toFixed(3));
			});
			
			// This makes popup unclickable...
			$("#btnZoomTo").on('shown.bs.modal',function(){
				$(document).off('focusin.bs.modal');
			});
			
			$('#btnZoomToGo').click(function() {
				var map = threeDGIS.twoDView.map;
				map.setCenter(new SuperMap.LonLat(Number($('#txtEasting').val()), Number($('#txtNorthing').val())), 5);
			});
		
			/*$('#get-checked-data').on('click', function(event) {
				event.preventDefault(); 
				var checkedItems = {}, counter = 0;
				$("#check-list-box li.active").each(function(idx, li) {
					checkedItems[counter] = $(li).text();
					counter++;
				});
				$('#display-json').html(JSON.stringify(checkedItems, null, '\t'));
			});*/
		});
		
		$( window ).resize(function() {
			resizeElement();
		});
		
		function resizeElement() {
			$('#viewContainer').width(($(window).width()-50)+'px');
			
			// Changing height of several components, may conclude into one or something
			$('#upperDiv').height(($(window).height()-35)+'px');
			$('#leftPanel').height(($(window).height()-35)+'px');
			$('.sidebar').height(($(window).height()-35)+'px');
		}
		
		function getCheckedData() {
			var checkedItems = {}, counter = 0;
			$("li.active").each(function(idx, li) {
				checkedItems[counter] = $(li).text();
				counter++;
			});
			console.log(JSON.stringify(checkedItems, null, '\t'));
		}
		
		$('#btnStreetView').click(function() {
			if($('#streetViewContainer').css('display')=='none')
			{
				streetViewMode();
				$('#btnWalkmode').parent().css('display','none');
			}
			else
			{
				cesiumMode();
				$('#btnWalkmode').parent().css('display','block');
			}
		});
		
		$('.btnToggleMapMode').click(function() {
			threeDGIS.toggle23D();
		});
		
		$('#icon3DMeasure').click(function() {
			threeDGIS.threeDView.removeAnalysisEntities();
			threeDGIS.threeDView.initDistanceMeasure();
		});
		
		$('#selectEditMode').change(function() {
			var modeNo = $('#selectEditMode').val();
			threeDGIS.twoDView.ctrlModifyVertex.mode = modeNo;
		});
		
		$('#btnCapture').click(function() {
			/*
			 * Currently for 3D only, may have condition whether to capture 3D or 2D.
			 * I don't think split screen should be captured both.
			 */
			
			if(threeDGIS.mode[0]=="3D" && threeDGIS.mode.length==1)
			{
				// $('#cesiumContainer').width($('#cesiumContainer').width()*3);
				// $('#cesiumContainer').height($('#cesiumContainer').height()*3);
				
				var scene = threeDGIS.threeDView.viewer.scene;
				scene.layers.find('AAM_Model').lodRangeScale = 0.05;
				scene.layers.find('PolyU').lodRangeScale = 0.05;
				scene.layers.find('cyber_port').lodRangeScale = 0.05;
				scene.layers.find('TaiKooShing').lodRangeScale = 0.05;
				scene.layers.find('SaiKung').lodRangeScale = 0.05;
				
				$('#txtSystemInfo').val('Preparing more detailed model for screen capture.');
				console.log(scene.canvas);
				
				setTimeout(function() {
					var canvas = scene.canvas;
					// console.log(canvas);
					canvas.toBlob(function(blob) {
						saveAs(blob, "screenshot.png");
						$('#txtSystemInfo').val('Screen captured successfully.');
						
						// $('#cesiumContainer').width($('#cesiumContainer').width()/3);
						// $('#cesiumContainer').height($('#cesiumContainer').height()/3);
						
						resizeElement();
						
						setTimeout(function() {
							scene.layers.find('AAM_Model').lodRangeScale = 0.4;
							scene.layers.find('PolyU').lodRangeScale = 0.4;
							scene.layers.find('cyber_port').lodRangeScale = 0.4;
							scene.layers.find('TaiKooShing').lodRangeScale = 0.4;
							scene.layers.find('SaiKung').lodRangeScale = 0.4;
						},300);
					}, "image/png");
				}, 12000);	// 5 sec does not seem to be enough, but not yet found any event or promise indicating that refresh is done
			}
			else if(threeDGIS.mode[0]=="2D" && threeDGIS.mode.length==1)
			{
				/*html2canvas(document.getElementById('SMapContainer'), {
					onrendered: function(canvas) {
						canvas.toBlob(function(blob) {
							saveAs(blob, "screenshot.png");
						}, "image/png");
						canvas.style.display = 'none';
					}
				});*/
				
				MapToImg&&MapToImg.excute(threeDGIS.twoDView.map);
			}
		});
		
		$('#btnAddModel').click(function() {
			threeDGIS.threeDView.addGLTFFlag = true;
		});
		
		$('#btnBuffer').click(function() {
			// threeDGIS.threeDView.pointBufferFlag = true;
			$('#bufferModal').modal('show');
		});
		
		$('#btnBufferSubmit').click(function() {
			threeDGIS.threeDView.bufferFlag = true;
			threeDGIS.threeDView.removeAnalysisEntities();
			threeDGIS.threeDView.startDrawing($('#bfrType').val());
			
			/*switch($('#bfrType').val()) {
				case 'object':
					;	// Does not seem to have anything to do here...
					break;
				default:
					threeDGIS.threeDView.startDrawing($('#bfrType').val());
			}*/
		});
		
		$('#iconSettings').click(function() {
			$('#settingModal').modal('show');
		});
		
		$('#checkBldg').change(function() {
			var layerBldgVec = threeDGIS.threeDView.viewer.scene.layers.find('bldg_wgs');
			
			if($(this).prop('checked')){
				layerBldgVec.setQueryParameter({
					url: host+'/iserver/services/data-Phase2_Data/rest/data',
					dataSourceName: '10.40.106.82_P2_Sample_Data',
					dataSetName: 'Bldg_HK80',
					keyWord: 'SmID'
				});
			}
			else
				layerBldgVec.queryParameter = undefined;
		});
		
		$('#checkPodium').change(function() {
			var layerPodiumVec = threeDGIS.threeDView.viewer.scene.layers.find('podium_wgs');
			
			if($(this).prop('checked')){
				layerPodiumVec.setQueryParameter({
					url: host+'/iserver/services/data-Phase2_Data/rest/data',
					dataSourceName: '10.40.106.82_P2_Sample_Data',
					dataSetName: 'Bldg_HK80',
					keyWord: 'SmID'
				});
			}
			else
				layerPodiumVec.queryParameter = undefined;
		});
		
		$('#checkAAM').change(function() {
			var layerAAM = threeDGIS.threeDView.viewer.scene.layers.find('AAM_Model');
			
			if($(this).prop('checked')){
				layerAAM.setQueryParameter({
					url: host+'/iserver/services/data-Phase2_Data/rest/data',
					dataSourceName: '10.40.106.82_P2_Sample_Data',
					dataSetName: 'AAM_Model',
					keyWord: 'SmID'
				});
			}
			else
				layerAAM.queryParameter = undefined;
		});
	</script>
	
	<!-- Bookmark manager -->
	<script>
		var bookmark3DUrl = host + '/iserver/services/data-Bookmark/rest/data/datasources/SmBookmark/datasets/Bookmark3D';
		var bookmarkDataUrl = host + '/iserver/services/data-Bookmark/rest/data';
		
		function initBookmark() 	// Write existing bookmarks into the select list
		{
			init();
			$('#bookmarks').on('mouseup', function(){
				var open = $('#bookmarks').data("isopen");
				if($('#bookmarks').data("isopen"))
				{
					var id = $('#bookmarks option:selected').val();
					
					if(id==-1)
						$('#deleteButton').prop('disabled', true);
					else
					{
						var getFeatureParam, getFeatureBySQLService, getFeatureBySQLParams;			
						getFeatureParam = new SuperMap.REST.FilterParameter({
							name: "Bookmark3D@SmBookmark",	// Modify this to switch between 2D and 3D
							attributeFilter: "SMID = " + id
						});
						getFeatureBySQLParams = new SuperMap.REST.GetFeaturesBySQLParameters({
							queryParameter: getFeatureParam,
							datasetNames:["SmBookmark:Bookmark3D"]	// Modify this to switch between 2D and 3D
						});
						getFeatureBySQLService = new SuperMap.REST.GetFeaturesBySQLService(bookmarkDataUrl, {
							eventListeners: {"processCompleted": flyToBookmark, "processFailed": processFailed}});

						getFeatureBySQLService.processAsync(getFeatureBySQLParams);
					}
				}
				$('#bookmarks').data("isopen", !open);
			});
		}
		
		function init()
		{
			$('#bookmarks').empty();
			
			var getFeatureParam, getFeatureBySQLService, getFeatureBySQLParams;
			getFeatureParam = new SuperMap.REST.FilterParameter({
				name: "Bookmark3D@SmBookmark",
				attributeFilter: "SMID > -1"
			});
			getFeatureBySQLParams = new SuperMap.REST.GetFeaturesBySQLParameters({
				queryParameter: getFeatureParam,
				datasetNames:["SmBookmark:Bookmark3D"],
				toIndex: 9999
			});
			getFeatureBySQLService = new SuperMap.REST.GetFeaturesBySQLService(bookmarkDataUrl, {
				eventListeners: {"processCompleted": findBookmarkCompleted, "processFailed": processFailed}});

			getFeatureBySQLService.processAsync(getFeatureBySQLParams);
		}
		
		function findBookmarkCompleted(getFeaturesEventArgs) {
			$('#bookmarks').append($("<option></option>").attr("value",-1).text("")); 

			var i, len, features, feature, result = getFeaturesEventArgs.result;
			if (result && result.features) {
				features = result.features;
				for (i=0, len=features.length; i<len; i++) {
					feature = features[i];
					
					$('#bookmarks').append($("<option></option>").attr("value",feature.data.SMID).text(feature.data.NAME));
				}
			}
		}
		
		function flyToBookmark(getFeaturesEventArgs) {
			var viewer = threeDGIS.viewer3D;
			
			var i, len, features, feature, result = getFeaturesEventArgs.result;
			if (result && result.features) {
				features = result.features;
				for (i=0, len=features.length; i<len; i++) {
					feature = features[i];
					
					var lat = feature.geometry.y*180/Math.PI;
					var lng = feature.geometry.x*180/Math.PI;
					var height = Number(feature.data.HEIGHT);
					var heading = Number(feature.data.HEADING);
					var tilt = Number(feature.data.TILT);
					
					var time = 3;
					var cartesianPosition = Cesium.Cartesian3.fromDegrees(lng, lat, height);
					
					viewer.camera.flyTo({
						destination: cartesianPosition,
						orientation: {
							heading: heading,
							pitch: tilt,
							roll: 0
						},
						duration: time
					});
				}
				$('#deleteButton').prop('disabled', false);
			}
			else
				$('#deleteButton').prop('disabled', true);
		}
		
		function addBookmark()
		{
			var name = prompt("Specify the name of the bookmark");
			var viewer = threeDGIS.viewer3D;
			
			// Add the current position to bookmark
			var camera = viewer.scene.camera;
			var cameraCartoPosition = Cesium.Cartographic.fromCartesian(camera.position);
			var geometry = new SuperMap.Geometry.Point(cameraCartoPosition.longitude, cameraCartoPosition.latitude);
			
			//var name = "A bookmark";	// Give a textbox to save the bookmark
			if(name!=""&&name!="undefined"&&name!=null)
			{
				// First list which layers involved and whether visible
				var visibleLayers='', invisibleLayers='';
				
				var jsonString = '{"x":'+geometry.x+',"y":'+geometry.y+',"Height":'+cameraCartoPosition.height
					+',"Heading":'+camera.heading+',"Tilt":'+camera.pitch
					+',"Service":"","Scene":"","Name":"'+name
					+'","Visible_Layers":"'+visibleLayers+'","Invisible_Layers":"'+invisibleLayers
					+'","type":"ADD"}';
				
				var dObject = {
					json: jsonString
				};
				
				$.ajax({
					url: host+'/iserver/BookmarkEditing.jsp',
					data: dObject,
					dataType: "json",
					method: 'POST',		// Need more advanced jquery version, later than 1.9.0
					success: function (data) {                                  
						var state = data.state;
						if(state=='Success')
						{
							alert("Bookmark added");
							init();
						}
						else
							alert("Failed to add bookmark");
					},
					error: function(err) {
						alert("AJAX function failed");
						window.open(host+'/iserver/BookmarkEditing.jsp'+'?json='+jsonString);
					}
				});
			}
		}
		
		function deleteBookmark()
		{
			var id = $('#bookmarks option:selected').val();
			
			if(id!=-1)
			{
				var jsonString = '{"ids":[';
					jsonString += id;
					jsonString += '],"type":"DELETE"}';
				
				var dObject = {
					json: jsonString
				};
				
				$.ajax({
					url: host+'/iserver/BookmarkEditing.jsp',
					data: dObject,
					dataType: "json",
					method: 'POST',		// Need more advanced jquery version, later than 1.9.0
					success: function (data) {                                  
						var state = data.state;
						if(state=='Success')
						{
							alert("Delete bookmark success");
							init();
						}
						else
							alert("Delete bookmark failed");
					},
					error: function(err) {
						alert("AJAX function failed");
						window.open(host+'/iserver/BookmarkEditing.jsp'+'?json='+jsonString);
					}
				});
			}
		}
		
		function processFailed(e) {
			alert(e.error.errorMsg);
		}
	</script>
	
	<!-- Attribute search -->
	<script>
		var dataUrl = host + '/iserver/services/data-Phase2_Data/rest/data';
		var tableHTML = '';
		
		$('#searchButton').click(function() {
			var viewer = threeDGIS.threeDView.viewer;
			viewer.scene.layers.find('bldg_wgs').releaseSelection();
			viewer.entities.removeById('locationResult');
			threeDGIS.threeDView.removeAllLabels();
			
			/*fields = [];
			var attributeValue = $('#queryValue').val();
			
			var searchCriteria = $('#selSearchCriteria option:selected').val();
			var layerToSearch, db, selectColumn;
			if(searchCriteria=='bldgName')
			{
				layerToSearch = 'bldg';
				db = '10.40.106.82_P2_Sample_Data';
				selectColumn = 'NAME_ENG';
			}
			else
			{
				layerToSearch = 'APPLICATION_WGS84';
				db = '10.40.106.82_R3DGIS_GISDB';
				selectColumn = 'APP_CASE_NO';
			}
			
			var getFeatureParam, getFeatureBySQLService, getFeatureBySQLParams;
			//alert("APP_CASE_NO LIKE '"+attributeValue+"%' OR LOCAT_ADDR LIKE '%"+attributeValue+"%'");

			getFeatureParam = new SuperMap.REST.FilterParameter({
				name: layerToSearch+'@'+db,
				//attributeFilter: "APP_CASE_NO='"+attributeValue+"'"
				attributeFilter: selectColumn+" LIKE '%"+attributeValue+"%'",
				orderBy: selectColumn
			});
			
			getFeatureBySQLParams = new SuperMap.REST.GetFeaturesBySQLParameters({
				queryParameter: getFeatureParam,
				datasetNames:[db+":"+layerToSearch],		// Hardcode
				toIndex: 999999
			});
			getFeatureBySQLService = new SuperMap.REST.GetFeaturesBySQLService(dataUrl, {
				eventListeners: {"processCompleted": featureQueryCompleted, "processFailed": processFailed}
			});

			getFeatureBySQLService.processAsync(getFeatureBySQLParams);*/
			
			// Debug
			var dObject = {
				json: '{"name":"'+$('#queryValue').val()+'"}'
			};
			
			$.ajax({
				url: host+'/iserver/LocationSearch.jsp',
				data: dObject,
				// dataType: "json",
				method: 'GET',		// Need more advanced jquery version, later than 1.9.0
				contentType: "application/x-www-form-urlencoded; charset=UTF-8",
				success: function (data) {                                  
					var obj = data;
					console.log(data.length);
					
					for(var i=0; i<obj.length; i++)
					{
						console.log(data[i].SMID+" "+data[i].Name+" "+data[i].LAYERTYPE);
					}
					
					if(data.length==0)
					{
						$('#attributeTable').bootstrapTable('refreshOptions',{
							columns:[]
						});
						
						$('#attributeTable').bootstrapTable('removeAll');
						$('#attributeTable').bootstrapTable( 'resetView' , {height: 149} );
						$('#iconAttributeTable').click();
					}
					else
					{
						// Modify the following
						var columns = [];
						var tableObjs = [];
						var $table = $('#attributeTable');
						
						/*if(features[0].attributes.APP_CASE_NO==undefined)	// Hard code to determine whether it is building or application
						{
							columns.push({
								checkbox: true
							});
						}*/
						
						for(var i=0; i<data.length; i++)
						{
							var row = {};
							var e, n, w, s;
							for (var property in data[i]) {
								if(property.toUpperCase().substr(0,2) != 'SM' || property.toUpperCase()=='SMID')
								{
									if(i==0)
									{
										columns.push({
											field: property,                   
											title: property,
											sortable: true,
											filter: {
												type: "input"
											}
										});
									}
									
									row[property] = data[i][property];
								}
								else if(property.toUpperCase()=='SMSDRIE')
									e = data[i][property];
								else if(property.toUpperCase()=='SMSDRIN')
									n = data[i][property];
								else if(property.toUpperCase()=='SMSDRIW')
									w = data[i][property];
								else if(property.toUpperCase()=='SMSDRIS')
									s = data[i][property];
							}
							var lngStr, latStr;
							if(e!=null)
							{
								lngStr = (e+w)/2;
								latStr = (n+s)/2;
							}
							else
							{
								lngStr = w;
								latStr = n;
							}
							row['Coordinate'] = '('+lngStr.toFixed(3)+', '+latStr.toFixed(3)+')';
							tableObjs.push(row);
						}
						columns.push({
							field: 'Coordinate',                   
							title: 'Coordinate',
							sortable: true,
							filter: {
								type: "input"
							}
						});
						$('#attributeTable').bootstrapTable('refreshOptions',{
							columns:columns,
							filter:true,
							exportDataType: 'all'
						});
						
						$('#attributeTable').bootstrapTable('removeAll');
						$('#attributeTable').bootstrapTable( 'resetView' , {height: 400} );
						$('#attributeTable').bootstrapTable('append', tableObjs);

						$('#attributeTable').off('dbl-click-cell.bs.table');
						$('#attributeTable').on('dbl-click-cell.bs.table',function(e, field, value, row) {
							if(threeDGIS.threeDView.viewMode!='Bird-eye')
								return;		// Don't fly under human view mode

							/*function flyToCase(getFeaturesEventArgs)
							{						
								var features = getFeaturesEventArgs.result.features;
								var geometry = features[0].geometry;
								var vertices = geometry.getVertices();
								var viewer = threeDGIS.threeDView.viewer;
								
								if(viewer.entities.getById('APP_HIGHLIGHT')!=undefined)
								{
									viewer.entities.removeById('APP_HIGHLIGHT');
									threeDGIS.threeDView.removeAllLabels();
								}
								
								var cesiumVertices = [];
								var cartos = []
								for(var i=0; i<vertices.length; i++)
								{
									var lng = vertices[i].x;
									var lat = vertices[i].y;
									var carto = new Cesium.Cartographic(lng*Math.PI/180, lat*Math.PI/180);
									cartos.push(carto);
									var h = viewer.scene.globe.getHeight(carto);
									cesiumVertices.push(Cesium.Cartesian3.fromDegrees(lng, lat, h));
								}
								Cesium.sampleTerrain(viewer.terrainProvider, 17, cartos)
									.then(function(samples) {
										var baseHeight = 999;
										var maxHeight = -99;
										
										for(var i=0; i<samples.length; i++)
										{									
											if(samples[i].height<baseHeight)
												baseHeight = samples[i].height;
											if(samples[i].height>maxHeight)
												maxHeight = samples[i].height;
										}
										
										var polygon = new Cesium.PolygonGraphics({
											hierarchy: new Cesium.PolygonHierarchy(cesiumVertices),
											extrudedHeight: maxHeight+10,
											height: baseHeight,
											material: new Cesium.Color(1.0, 0.2, 0.6, 0.7),
											outline: true,
											outlineColor : Cesium.Color.BLACK,
											outlineWidth : 10	// Does not seem to make any difference
										});
										
										viewer.entities.add({
											id: 'APP_HIGHLIGHT',
											polygon: polygon,
											outline: true,
											shadows: Cesium.ShadowMode.ENABLED		// Does not seem to be working
										});
									});
								
								var coordinate = row.Coordinate;
								var coordTemp = coordinate.substring(1,coordinate.length-1);
								var lnglat = coordTemp.split(', ');
								threeDGIS.threeDView.addLabel(row.APP_CASE_NO,Number(lnglat[0]),Number(lnglat[1]));
							}
							
							var layerToSearch = 'APPLICATION_WGS84';
							var db = '10.40.106.82_R3DGIS_GISDB';
							var selectColumn = 'APP_CASE_NO';
							
							getFeatureParam = new SuperMap.REST.FilterParameter({
								name: layerToSearch+'@'+db,
								//attributeFilter: "APP_CASE_NO='"+attributeValue+"'"
								attributeFilter: selectColumn + " = '" + row.APP_CASE_NO + "'",
								orderBy: selectColumn
							});
							
							getFeatureBySQLParams = new SuperMap.REST.GetFeaturesBySQLParameters({
								queryParameter: getFeatureParam,
								datasetNames:[db+":"+layerToSearch]
							});
							getFeatureBySQLService = new SuperMap.REST.GetFeaturesBySQLService(dataUrl, {
								eventListeners: {"processCompleted": flyToCase, "processFailed": processFailed}
							});

							getFeatureBySQLService.processAsync(getFeatureBySQLParams);
							*/
							
							if(viewer.entities.getById('locationResult')!=undefined)
							{
								viewer.entities.removeById('locationResult');
								threeDGIS.threeDView.removeAllLabels();
							}
							
							var coordinate = row.Coordinate;
							
							var coordTemp = coordinate.substring(1,coordinate.length-1);
							var lnglat = coordTemp.split(', ');
							var wgspt = CoordTransform.hk2wgs(lnglat[0], lnglat[1]);
							
							var carto = new Cesium.Cartographic(Number(wgspt[0])*Math.PI/180,Number(wgspt[1])*Math.PI/180);
							carto.height = threeDGIS.threeDView.viewer.scene.globe.getHeight(carto);
							
							/*threeDGIS.threeDView.viewer.scene.camera.flyTo({
								destination: Cesium.Cartesian3.fromDegrees(Number(wgspt[0]),Number(wgspt[1]),carto.height+400),
								orientation: {
									heading: 0,
									pitch: -Math.PI/2,
									roll: 0
								},
								duration: 2
							});*/
							
							threeDGIS.threeDView.addLabel(row.Name,Number(wgspt[0]),Number(wgspt[1]));

							// POINT
							// Tree
							// UtilityPoint
							
							// POLYLINE
							// RoadCenterLine
							
							// POLYGON
							// APPLICATION
							// GLA
							// SSSI
							// Site
							// OZP_PLAN
							// BUILDING
							// PlaneNameAnno
							// TenancyPoly
							// AMENDMENT
							
							function flyToCase(e) {
								console.log(e.result);	// Why this implements for many times?
								var feature = e.result.features[0];
								var geometry = feature.geometry;
								
								if(geometry==null)		// Feature geometry not interpreted. May be this is a 3D format not yet readable
								{
									var x = feature.data.SMX;
									var y = feature.data.SMY;
									
									var wgspt = CoordTransform.hk2wgs(x, y);
									var carto = new Cesium.Cartographic(wgspt[0]*Math.PI/180,wgspt[1]*Math.PI/180);
									
									Cesium.sampleTerrain(threeDGIS.threeDView.viewer.terrainProvider, 17, [carto])
										.then(function(samples) {
											var entity = threeDGIS.threeDView.viewer.entities.add({
												position : Cesium.Cartesian3.fromDegrees(samples[0].longitude*180/Math.PI, samples[0].latitude*180/Math.PI, samples[0].height),
												billboard : {
													image : 'assets/image/marker.png',
													width : 20,
													height : 32,
													eyeOffset: new Cesium.Cartesian3(0,0,-10),
													pixelOffset: new Cesium.Cartesian2(0,-16)
												},
												id: 'locationResult'
											});
										});
										
										threeDGIS.threeDView.viewer.flyTo(entity);
								}
								else
								{
									if(geometry instanceof SuperMap.Geometry.Point)
									{
										console.log('point');
										console.log(geometry);
										
										var pt = geometry.getVertices()[0];
										var x = pt.x;
										var y = pt.y;
										
										var wgspt = CoordTransform.hk2wgs(x, y);
										var carto = new Cesium.Cartographic(wgspt[0]*Math.PI/180,wgspt[1]*Math.PI/180);
										
										Cesium.sampleTerrain(threeDGIS.threeDView.viewer.terrainProvider, 17, [carto])
											.then(function(samples) {
												var entity = threeDGIS.threeDView.viewer.entities.add({
													position : Cesium.Cartesian3.fromDegrees(samples[0].longitude*180/Math.PI, samples[0].latitude*180/Math.PI, samples[0].height),
													billboard : {
														image : 'assets/image/marker.png',
														width : 20,
														height : 32,
														eyeOffset: new Cesium.Cartesian3(0,0,-10),
														pixelOffset: new Cesium.Cartesian2(0,-16)
													},
													id: 'locationResult'
												});
											});
											
											threeDGIS.threeDView.viewer.flyTo(entity);
									}
									else if(geometry instanceof SuperMap.Geometry.Polygon || geometry instanceof SuperMap.Geometry.MultiPolygon)
									{
										console.log('polygon');
										console.log(geometry);
										var verticesHK = geometry.getVertices();
										var cartos = [];
										for(var i=0; i<verticesHK.length; i++)
										{
											var x = verticesHK[i].x;
											var y = verticesHK[i].y;
											
											var wgspt = CoordTransform.hk2wgs(x, y);
											cartos.push(new Cesium.Cartographic(wgspt[0]*Math.PI/180,wgspt[1]*Math.PI/180));
										}
										
										var centroidHK = geometry.getCentroid();
										var centroidWGS = CoordTransform.hk2wgs(centroidHK.x, centroidHK.y);
										
										Cesium.sampleTerrain(threeDGIS.threeDView.viewer.terrainProvider, 17, cartos)
											.then(function(samples) {
												var baseHeight = 9999, topHeight = -9999;
												var degs = [];
												for(var i=0; i<samples.length; i++)
												{
													var height = samples[i].height;
													if(baseHeight>height)
														baseHeight = height;
														
													if(topHeight<height)
														topHeight = height;
														
													degs.push(samples[i].longitude*180/Math.PI);
													degs.push(samples[i].latitude*180/Math.PI);
												}
												
												var polygon = new Cesium.PolygonGraphics({
													hierarchy: new Cesium.PolygonHierarchy(Cesium.Cartesian3.fromDegreesArray(degs)),
													extrudedHeight: topHeight+10,
													height: baseHeight,
													material: new Cesium.Color(1.0, 0.2, 0.6, 0.7),
													outline: true,
													outlineColor : Cesium.Color.BLACK,
													outlineWidth : 10,	// Does not seem to make any difference
													shadows: Cesium.ShadowMode.RECEIVE_ONLY
												});
												
												var entity = viewer.entities.add({
													id: 'locationResult',
													polygon: polygon,
													outline: true,
													shadows: Cesium.ShadowMode.RECEIVE_ONLY
												});
												threeDGIS.threeDView.viewer.flyTo(entity);
											});
									}
									else if(geometry instanceof SuperMap.Geometry.LineString || geometry instanceof SuperMap.Geometry.MultiLineString)	// Polyline
									{
										console.log('polyline');
										console.log(geometry);
										
										var bufferAnalystCompleted = function(args) {
											if(args){
												var bufferResultGeometry = args.result.resultGeometry;
												var hkVertices = bufferResultGeometry.getVertices();
												
												// Convert the HK80 coordinate of the vertices to WGS84 and then plot out
												var wgsVertices = [];
												for(var i=0; i<hkVertices.length; i++)
												{
													var wgspt = CoordTransform.hk2wgs(hkVertices[i].x, hkVertices[i].y);
													wgsVertices.push(Cesium.Cartesian3.fromDegrees(wgspt[0],wgspt[1]));
												}
												
												var polygon = new Cesium.PolygonGraphics({
													hierarchy: new Cesium.PolygonHierarchy(wgsVertices),
													material: new Cesium.Color(1.0, 0.2, 0.6, 0.7),
													outline: true,
													outlineColor : Cesium.Color.BLACK,
												});
												
												var entity = threeDGIS.threeDView.viewer.entities.add({
													id: 'locationResult',
													polygon: polygon,
													outline: true,
													shadows: Cesium.ShadowMode.ENABLED		// Does not seem to be working
												});
												
												threeDGIS.threeDView.viewer.flyTo(entity);
											}
										}
										
										var bufferServiceByGeometry = new SuperMap.REST.BufferAnalystService(host+'/iserver/services/spatialAnalysis-Phase2_Data/restjsr/spatialanalyst'),
											bufferDistance = new SuperMap.REST.BufferDistance({
												value: 2.5
											}),
											bufferSetting = new SuperMap.REST.BufferSetting({
												endType: SuperMap.REST.BufferEndType.ROUND,
												leftDistance: bufferDistance,
												rightDistance: bufferDistance,
												semicircleLineSegment: 20
											}),
											geoBufferAnalystParam = new SuperMap.REST.GeometryBufferAnalystParameters({
												sourceGeometry: geometry,
												bufferSetting: bufferSetting
											});

										bufferServiceByGeometry.events.on({"processCompleted": bufferAnalystCompleted});
										bufferServiceByGeometry.processAsync(geoBufferAnalystParam);
									}
								}
							}
							
							var db = '10.40.106.82_R3DGIS_GISDB', layerToSearch = row.LAYERTYPE;
							var featureID = row.SMID;
							getFeatureParam = new SuperMap.REST.FilterParameter({
								name: layerToSearch+'@'+db,
								//attributeFilter: "APP_CASE_NO='"+attributeValue+"'"
								attributeFilter: "SMID = " + featureID
							});
							
							getFeatureBySQLParams = new SuperMap.REST.GetFeaturesBySQLParameters({
								queryParameter: getFeatureParam,
								datasetNames:[db+":"+layerToSearch]
							});
							getFeatureBySQLService = new SuperMap.REST.GetFeaturesBySQLService(dataUrl, {
								eventListeners: {"processCompleted": flyToCase, "processFailed": processFailed}
							});

							getFeatureBySQLService.processAsync(getFeatureBySQLParams);
						});
						$('#iconAttributeTable').click();
					}
				},
				error: function(err) {
					console.log(err);
					console.log(err.responseText)
					alert("AJAX function failed");
					//$('#log').html(err.responseText);
				}
			});
		});
		
		$('#iconSplitScreen').click(function() {
			var scene = threeDGIS.threeDView.viewer.scene;
			if(scene.multiViewportMode == Cesium.MultiViewportMode.NONE)
			{
				scene.multiViewportMode = Cesium.MultiViewportMode.HORIZONTAL;
				threeDGIS.mode = ['3D','3D'];
			}
			else
			{
				scene.multiViewportMode = Cesium.MultiViewportMode.NONE;
				threeDGIS.mode = ['3D'];
			}
		});
	</script>
	
	<!-- Attribute table -->
	<script>
		// Already defined on the search session
		// var dataUrl = htmlUrl + '/iserver/services/data-PlanD_Phase1/rest/data';
		var tableHTML = '';
		
		function initAttributeTable() {
			loadAttributeTable('AAM_Model');	// Hardcode on layer name
        }
		
		function loadAttributeTable(layerName)
		{
			fields = [];
			var getFeatureParam, getFeatureBySQLService, getFeatureBySQLParams;

			getFeatureParam = new SuperMap.REST.FilterParameter({
				name: layerName,
				attributeFilter: "SMID > -1"
			});
			getFeatureBySQLParams = new SuperMap.REST.GetFeaturesBySQLParameters({
				queryParameter: getFeatureParam,
				// datasetNames:["SQLServerSource:"+layerNameSplit[0]],	// Currently hardcode the datasource first
				datasetNames:["10.40.106.82_P2_Sample_Data:AAM_Model"],
				toIndex:999999
			});
			getFeatureBySQLService = new SuperMap.REST.GetFeaturesBySQLService(dataUrl, {
				eventListeners: {"processCompleted": getFeatureCompleted, "processFailed": processFailed}
			});

			getFeatureBySQLService.processAsync(getFeatureBySQLParams);
		}
		
		function getFeatureCompleted(getFeaturesEventArgs)
		{
			var i, len, features, feature, result = getFeaturesEventArgs.result;
			if (result && result.features) {
				features = result.features;
				
				ThreeDGIS.rewriteAttributeTable(features);
			}
		}
	</script>
	
	<!-- Google street view -->
	<script>
		var panorama;	// A variable to store google street view container
	
		function initGoogleStreet() {
			var fenway = {lat: 22.28, lng: 114.14};
			panorama = new google.maps.StreetViewPanorama(
				document.getElementById('streetViewContainer'), {
					position: fenway,
					pov: {
						heading: 34,
						pitch: 0
					},
					linksControl: false,
					panControl: false,
					enableCloseButton: false,
					zoomControl: false
					// addressControl: false
				}
			);
		}
		
		// May also want fov
		function positionStreetView (stLat, stLng, stHeading, stPitch) {
			if(google==undefined)
			{
				alert("Street view not available. Check internet accessibility.");
				return;
			}
			
			$('#streetViewContainer').css('display','block');
			
			panorama = new google.maps.StreetViewPanorama(
				document.getElementById('streetViewContainer'), {
					position: {lat: stLat*180/Math.PI, lng: stLng*180/Math.PI},
					pov: {
						heading: stHeading*180/Math.PI,
						pitch: stPitch*180/Math.PI
					},
					linksControl: false,
					panControl: false,
					enableCloseButton: false,
					zoomControl: false
					// addressControl: false
				}
			);
			var fov = threeDGIS.threeDView.viewer.camera.frustum.fov;
			var zoom = 1-Math.log(Math.tan(fov/2))/Math.log(2);
			panorama.setZoom(zoom);
			
			google.maps.event.addListener(panorama, 'position_changed', function() {
				var position = panorama.getPosition();
				var pov = panorama.getPov();
				
				var lng = position.lng();
				var lat = position.lat();
				var heading = pov.heading*Math.PI/180;
				var pitch = pov.pitch*Math.PI/180;
				
				var carto = new Cesium.Cartographic(lng*Math.PI/180, lat*Math.PI/180);
				var viewHeight = threeDGIS.threeDView.viewer.scene.globe.getHeight(carto);
				
				threeDGIS.threeDView.viewer.camera.flyTo({
					destination: Cesium.Cartesian3.fromDegrees(lng,lat,viewHeight),
					orientation: {
						heading: heading,
						pitch: pitch,
						roll: 0
					},
					duration: 1
				});
				threeDGIS.threeDView.viewer.camera.frustum.fov = Math.atan(Math.pow(2, 1-(pov.zoom)))*2;
			});
			/*panorama.addListener('position_changed', function() {
				
			});*/
			
			google.maps.event.addListener(panorama, 'pov_changed', function() {
				var pov = panorama.getPov();
				
				var heading = pov.heading*Math.PI/180;
				var pitch = pov.pitch*Math.PI/180;
				
				threeDGIS.threeDView.viewer.camera.setView({
					orientation: {
						heading: heading,
						pitch: pitch,
						roll: 0
					}
				});
				threeDGIS.threeDView.viewer.camera.frustum.fov = Math.atan(Math.pow(2, 1-(pov.zoom)))*2;
			});
			/*panorama.addListener('pov_changed', function() {
				var pov = panorama.getPov();
				
				var heading = pov.heading*Math.PI/180;
				var pitch = pov.pitch*Math.PI/180;
				
				threeDGIS.threeDView.viewer.camera.setView({
					orientation: {
						heading: heading,
						pitch: pitch,
						roll: 0
					}
				});
			});*/
		}
		
		function streetViewMode () {
			var viewer = threeDGIS.viewer3D;
			
			var cpCarto = viewer.scene.camera.positionCartographic;
			
			var stLat = cpCarto.latitude;
			var stLng = cpCarto.longitude;
			var stHeading = viewer.scene.camera.heading;
			var stPitch = viewer.scene.camera.pitch;
			
			positionStreetView(stLat, stLng, stHeading, stPitch);
		}
		
		function cesiumMode () {
			$('#streetViewContainer').css('display','none');
		}
	</script>
	
	<!-- Profile analysis -->
	<script>
		function initProfile() {
			var viewer = threeDGIS.viewer3D;
			
			$('#btnProfile').click(function() {
				deactiveAll();
				handlerLine.activate();
			});
			function deactiveAll(){
				handlerLine.deactivate();
			}
			function addResultLayer() {
				if(!resultObject){
					alert('No profile line plot!');
					return ;
				}
				var line = CesiumToSuperMap.convertPolyline(Cesium,SuperMap,resultObject);
				// var profileUrl = 'http://pld-3dappdev.pland.hksarg/iserver/services/spatialAnalysis-PlanD_Phase1/restjsr/spatialanalyst/datasets/DTM_2@data/terraincalculation/profile.jsonp?returnContent=true';
				var points = [];
				
				for(var i=0; i<=1; i++)
				{
					var hkpt = CoordTransform.wgs2hk(line.getVertices()[i].x, line.getVertices()[i].y);
					points.push(new SuperMap.Geometry.Point(hkpt[0], hkpt[1]));
				}
				// points.push(new SuperMap.Geometry.Point(line.getVertices()[0].x, line.getVertices()[0].y));
				// points.push(new SuperMap.Geometry.Point(line.getVertices()[1].x, line.getVertices()[1].y));
				var serverGeometry = new SuperMap.REST.ServerGeometry({
					id : 0,//???number??
					style : null,
					parts : [2],
					type : 'LINE',
					points : points,
					prjCoordSys : null
				});
				SuperMap.Util.committer({
					method : 'POST',
					url : profileUrl,
					data : {
						line : serverGeometry,
						resampleTolerance : '0.5'
					},
					success : function(args){
						buildProfile(args);
					},
					failure : function(err){
						console.log(err);
					}
				});
			}

			function buildProfile(result){
				var profileRes = result.profile[0];
				var xyCoord = result.xyCoordinate[0];
				if(!profileRes || !xyCoord){
					return ;
				}
				var xMax = 0,yMax = 0;
				var points = profileRes.points;
				var xyCoordPoints = xyCoord.points;
				var arr = [];
				for(var i = 0,j = points.length;i < j;i++){
					var x = points[i].x;
					var y = points[i].y;
					var lon = xyCoordPoints[i].x;
					var lat = xyCoordPoints[i].y;
					arr.push([x,y,lon,lat]);
					xMax = x > xMax ? x : xMax;
					yMax = y > yMax ? y : yMax;
				}
				myChart.clear();
				myChart.setOption({
					title : {
						text : '剖面图'
					},
					tooltip: {
						trigger: 'axis',
						formatter: function (params) {
							var param = params[0];
							var x = param.data[0];
							var y = param.data[1];
							var lon = param.data[2];
							var lat = param.data[3];
							return 'x : ' + lon + '</br>' + 'y : ' + lat + '</br>' + 'z : ' + y;
						},
						axisPointer: {
							animation: false
						}
					},
					toolbox: {
						feature: {
							saveAsImage: {},
							myTool1 : {
								show : true,
								title : '关闭',
								icon : 'path://M432.45,595.444c0,2.177-4.661,6.82-11.305,6.82c-6.475,0-11.306-4.567-11.306-6.82s4.852-6.812,11.306-6.812C427.841,588.632,432.452,593.191,432.45,595.444L432.45,595.444z M421.155,589.876c-3.009,0-5.448,2.495-5.448,5.572s2.439,5.572,5.448,5.572c3.01,0,5.449-2.495,5.449-5.572C426.604,592.371,424.165,589.876,421.155,589.876L421.155,589.876z M421.146,591.891c-1.916,0-3.47,1.589-3.47,3.549c0,1.959,1.554,3.548,3.47,3.548s3.469-1.589,3.469-3.548C424.614,593.479,423.062,591.891,421.146,591.891L421.146,591.891zM421.146,591.891',
								onclick : function(){
									$('#chart').hide();
								}
							}
						}
					},
					grid: {
						left: '3%',
						right: '4%',
						bottom: '3%',
						containLabel: true
					},
					xAxis : {
						min : 0,
						max : xMax*1.2,
						type : 'value'
					},
					yAxis : {
						type : 'value',
						min : 0,
						max : yMax*1.2
					},
					series : [{
						type : 'line',
						data : arr,
						showSymbol: false,
						color : 'green'
					}],
					backgroundColor : 'white',
					color : '#c23531'
				});
				$('#chart').show();
			}
			
			var scene = viewer.scene;
			
			var resultObject;
			var handlerLine = new Cesium.DrawHandler(viewer,Cesium.DrawMode.Line,1);
			handlerLine.drawEvt.addEventListener(function(result){
				resultObject = result.object;
				addResultLayer();
			});
			// viewer.flyTo(imageryLayer);
			var myChart = echarts.init(document.getElementById('chart'));
		}
	</script>
	
	<!-- Edit_block_mode.js -->
	<script>
		$('#iconEditBlock').click(function() {
			threeDGIS.split23D();
			
			var map = threeDGIS.twoDView.map;
			var mapLayers = map.layers;
			// Hide all current layers
			/*for(var i=0; i<mapLayers.length; i++)
				mapLayers[i].visibility = false;*/
				
            // threeDGIS.twoDView.addLayer('editor',host+"/iserver/services/map-Phase2_Data/rest/maps/AAM_Polygon");
			
			$('#toolset3D').css('display','none');
			$('#toolsetEditing').css('display','block');
			
			// threeDGIS.threeDView.selectBlockFlag = false;
			threeDGIS.threeDView.removeAnalysisEntities();
			threeDGIS.threeDView.clearSelection();
			
			// $('#btnEditConfirm').prop('disabled', false);
		});
		
		$('#btnBackTo3D').click(function() {
			$('#toolset3D').css('display','block');
			$('#toolsetEditing').css('display','none');
			
			threeDGIS.toggle23D();
			threeDGIS.threeDView.selectBlockFlag = true;
			$('#btnEditConfirm').prop('disabled', true);
			threeDGIS.threeDView.enableClickSelect();
		});
		
		$('#btnAddBlock').click(function() {
			$('#btnEditConfirm').prop('disabled', true);
			$('#txtArea').html('');
			$('#txtGFA').html('');
			$('#txtHt').html('');
			$('#txtNoFloor').html('');
			
			threeDGIS.twoDView.deactivateAll();
			threeDGIS.twoDView.ctrlDrawPoint.deactivate();
			
			var drawPolygon = threeDGIS.twoDView.ctrlDrawPolygon;
			drawPolygon.events.un({"featureadded": threeDGIS.twoDView.addFeatureCompletedHandler});
			drawPolygon.events.on({"featureadded": threeDGIS.twoDView.addFeatureCompletedHandler});
			
			threeDGIS.twoDView.vectorLayer.removeAllFeatures();
			threeDGIS.threeDView.addBlockSelection();
			// drawPolygon.deactivate();
			// clearAllDeactivate();
			drawPolygon.activate();
			
			$('#txtSystemInfo').val('Draw the block to be added on 2D map');
			threeDGIS.threeDView.enableClickSelect();
		});
		
		$('#btnDeleteBlock').click(function() {
			$('#btnEditConfirm').prop('disabled', true);
			$('#txtArea').html('');
			$('#txtGFA').html('');
			$('#txtHt').html('');
			$('#txtNoFloor').html('');
			
			threeDGIS.twoDView.deactivateAll();
			
			var drawPoint = threeDGIS.twoDView.ctrlDrawPoint;
			drawPoint.events.un({"featureadded": threeDGIS.twoDView.selectedFeature});
			drawPoint.events.un({"featureadded": threeDGIS.twoDView.selectedFeatureToDelete});
			drawPoint.events.on({"featureadded": threeDGIS.twoDView.selectedFeatureToDelete});
			
			threeDGIS.twoDView.vectorLayer.removeAllFeatures();
			threeDGIS.threeDView.addBlockSelection();
			
			$('#txtSystemInfo').val('Select a block to delete');
			ThreeDView.prototype.clickToDelete();
		});
		
		$('#btnEditConfirm').click(function() {
			if($('#btnEditConfirm').html()=='Start Edit')
			{
				$('#exBlockHeight').bootstrapSlider("enable");
				
				$('#btnEditConfirm').html('Confirm');
				var selectedFeature = threeDGIS.twoDView.feature;
				
				if(selectedFeature==undefined)
					$('#txtSystemInfo').val('No blocks selected');
				else
				{
					threeDGIS.twoDView.deactivateAll();
					threeDGIS.twoDView.ctrlDrawPoint.deactivate();
					
					var drawPoint = threeDGIS.twoDView.ctrlDrawPoint;
					//drawPoint.events.un({"featureadded": threeDGIS.twoDView.selectedFeature});
					drawPoint.events.un({"featureadded": threeDGIS.twoDView.selectedFeatureToDelete});
					drawPoint.events.on({"featureadded": threeDGIS.twoDView.selectedFeature});
					
					var updateControl = threeDGIS.twoDView.ctrlModifyVertex;
					threeDGIS.twoDView.ctrlModifyVertex.activate();
					
					//moveControl.onDrag = threeDGIS.twoDView.onMove;
					$('#txtSystemInfo').val('Click on selection to edit');
				}
			}
			else
			{
				$('#exBlockHeight').bootstrapSlider("disable");
				
				$('#btnEditConfirm').html('Start Edit');
				
				threeDGIS.twoDView.vectorLayer.removeAllFeatures();
				threeDGIS.twoDView.deactivateAll();
				threeDGIS.twoDView.ctrlDrawPoint.activate();
				
				threeDGIS.twoDView.updateFeature();
				$('#btnEditConfirm').prop('disabled', true);
			}
		});
	</script>
	
	<!-- Custom classes -->
	<script src="js/class/movement.js"></script>
	<script src="js/class/viewerComponents/twoDView.js"></script>
	<script src="js/class/viewerComponents/threeDView.js"></script>
	<script src="js/class/viewerComponents/3DGIS.js"></script>
	<script src="js/class/3DBlock.js"></script>
	<script src="js/MapToImg.js"></script>
	
	<script src="lib/proj4js/proj4.js"></script>
	<script src="lib/html2canvas/dist/html2canvas.min.js"></script>
	<script src="lib/FileSaver/FileSaver.min.js"></script>
	<script src="js/class/CoordTransform.js"></script>
	
	<script src="../iClient/for3D/webgl/examples/js/Convert.js"></script>
	<script src="../iClient/for3D/webgl/examples/js/echarts.min.js"></script>
	<script type="text/javascript" src="../iClient/for3D/webgl/examples/js/require.min.js" data-main="js/main"></script>
	<script src="../iClient/forJavaScript/libs/SuperMap.Include.js"></script>
	
	<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAggVsvpxvMh3YzAhOSwJkjYrlbvvxxFLo&callback=initGoogleStreet" type="text/javascript"></script>
</body>
</html>